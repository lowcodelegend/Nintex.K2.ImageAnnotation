(()=>{"use strict";var t=Object.defineProperty,e=(e,n,o)=>((e,n,o)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[n]=o)(e,"symbol"!=typeof n?n+"":n,o);function n(){}function o(t,e){for(const n in e)t[n]=e[n];return t}function i(t){return t()}function s(){return Object.create(null)}function r(t){t.forEach(i)}function a(t){return"function"==typeof t}function l(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function c(t,...e){if(null==t){for(const t of e)t(void 0);return n}const o=t.subscribe(...e);return o.unsubscribe?()=>o.unsubscribe():o}function d(t,e,n){t.$$.on_destroy.push(c(e,n))}function u(t,e,n,i){return t[1]&&i?o(n.ctx.slice(),t[1](i(e))):n.ctx}function p(t){const e={};for(const n in t)"$"!==n[0]&&(e[n]=t[n]);return e}function h(t){return t??""}function g(t,e){t.appendChild(e)}function f(t,e,n){t.insertBefore(e,n||null)}function m(t){t.parentNode&&t.parentNode.removeChild(t)}function y(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function $(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function w(t){return document.createTextNode(t)}function v(){return w(" ")}function b(){return w("")}function x(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function E(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function A(t,e,n){t.classList.toggle(e,!!n)}let _;function M(t){_=t}function S(){if(!_)throw new Error("Function called outside component initialization");return _}function T(t){S().$$.on_mount.push(t)}function L(){const t=S();return(e,n,{cancelable:o=!1}={})=>{const i=t.$$.callbacks[e];if(i){const s=function(t,e,{bubbles:n=!1,cancelable:o=!1}={}){return new CustomEvent(t,{detail:e,bubbles:n,cancelable:o})}(e,n,{cancelable:o});return i.slice().forEach(e=>{e.call(t,s)}),!s.defaultPrevented}return!0}}function O(t,e){const n=t.$$.callbacks[e.type];n&&n.slice().forEach(t=>t.call(this,e))}const I=[],k=[];let B=[];const C=[],Y=Promise.resolve();let V=!1;function D(){V||(V=!0,Y.then(P))}function N(){return D(),Y}function R(t){B.push(t)}const U=new Set;let X=0;function P(){if(0!==X)return;const t=_;do{try{for(;X<I.length;){const t=I[X];X++,M(t),H(t.$$)}}catch(t){throw I.length=0,X=0,t}for(M(null),I.length=0,X=0;k.length;)k.pop()();for(let t=0;t<B.length;t+=1){const e=B[t];U.has(e)||(U.add(e),e())}B.length=0}while(I.length);for(;C.length;)C.pop()();V=!1,U.clear(),M(t)}function H(t){if(null!==t.fragment){t.update(),r(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(R)}}const j=new Set;let G;function q(){G={r:0,c:[],p:G}}function F(){G.r||r(G.c),G=G.p}function W(t,e){t&&t.i&&(j.delete(t),t.i(e))}function z(t,e,n,o){if(t&&t.o){if(j.has(t))return;j.add(t),G.c.push(()=>{j.delete(t),o&&(n&&t.d(1),o())}),t.o(e)}else o&&o()}function K(t){return void 0!==(null==t?void 0:t.length)?t:Array.from(t)}function J(t){t&&t.c()}function Z(t,e,n){const{fragment:o,after_update:s}=t.$$;o&&o.m(e,n),R(()=>{const e=t.$$.on_mount.map(i).filter(a);t.$$.on_destroy?t.$$.on_destroy.push(...e):r(e),t.$$.on_mount=[]}),s.forEach(R)}function Q(t,e){const n=t.$$;null!==n.fragment&&(function(t){const e=[],n=[];B.forEach(o=>-1===t.indexOf(o)?e.push(o):n.push(o)),n.forEach(t=>t()),B=e}(n.after_update),r(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function tt(t,e,o,i,a,l,c=null,d=[-1]){const u=_;M(t);const p=t.$$={fragment:null,ctx:[],props:l,update:n,not_equal:a,bound:s(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(u?u.$$.context:[])),callbacks:s(),dirty:d,skip_bound:!1,root:e.target||u.$$.root};c&&c(p.root);let h=!1;if(p.ctx=o?o(t,e.props||{},(e,n,...o)=>{const i=o.length?o[0]:n;return p.ctx&&a(p.ctx[e],p.ctx[e]=i)&&(!p.skip_bound&&p.bound[e]&&p.bound[e](i),h&&function(t,e){-1===t.$$.dirty[0]&&(I.push(t),D(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}(t,e)),n}):[],p.update(),h=!0,r(p.before_update),p.fragment=!!i&&i(p.ctx),e.target){if(e.hydrate){const t=function(t){return Array.from(t.childNodes)}(e.target);p.fragment&&p.fragment.l(t),t.forEach(m)}else p.fragment&&p.fragment.c();e.intro&&W(t.$$.fragment),Z(t,e.target,e.anchor),P()}M(u)}class et{constructor(){e(this,"$$"),e(this,"$$set")}$destroy(){Q(this,1),this.$destroy=n}$on(t,e){if(!a(e))return n;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(e),()=>{const t=o.indexOf(e);-1!==t&&o.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add("4");var nt,ot=(t=>(t.ELLIPSE="ELLIPSE",t.MULTIPOLYGON="MULTIPOLYGON",t.POLYGON="POLYGON",t.POLYLINE="POLYLINE",t.RECTANGLE="RECTANGLE",t.LINE="LINE",t))(ot||{});nt={exports:{}},function(){function t(t,e){var n=t.x-e.x,o=t.y-e.y;return n*n+o*o}function e(t,e,n){var o=e.x,i=e.y,s=n.x-o,r=n.y-i;if(0!==s||0!==r){var a=((t.x-o)*s+(t.y-i)*r)/(s*s+r*r);a>1?(o=n.x,i=n.y):a>0&&(o+=s*a,i+=r*a)}return(s=t.x-o)*s+(r=t.y-i)*r}function n(t,o,i,s,r){for(var a,l=s,c=o+1;c<i;c++){var d=e(t[c],t[o],t[i]);d>l&&(a=c,l=d)}l>s&&(a-o>1&&n(t,o,a,s,r),r.push(t[a]),i-a>1&&n(t,a,i,s,r))}function o(t,e){var o=t.length-1,i=[t[0]];return n(t,0,o,e,i),i.push(t[o]),i}function i(e,n,i){if(e.length<=2)return e;var s=void 0!==n?n*n:1;return e=i?e:function(e,n){for(var o,i=e[0],s=[i],r=1,a=e.length;r<a;r++)t(o=e[r],i)>n&&(s.push(o),i=o);return i!==o&&s.push(o),s}(e,s),o(e,s)}nt.exports=i,nt.exports.default=i}();const it={},st=(t,e)=>it[t]=e,rt=t=>it[t.type].area(t),at=t=>{let e=1/0,n=1/0,o=-1/0,i=-1/0;return t.forEach(([t,s])=>{e=Math.min(e,t),n=Math.min(n,s),o=Math.max(o,t),i=Math.max(i,s)}),{minX:e,minY:n,maxX:o,maxY:i}},lt=t=>{let e=0,n=t.length-1;for(let o=0;o<t.length;o++)e+=(t[n][0]+t[o][0])*(t[n][1]-t[o][1]),n=o;return Math.abs(.5*e)},ct=(t,e,n)=>{let o=!1;for(let i=0,s=t.length-1;i<t.length;s=i++){const r=t[i][0],a=t[i][1],l=t[s][0],c=t[s][1];a>n!=c>n&&e<(l-r)*(n-a)/(c-a)+r&&(o=!o)}return o},dt=(t,e)=>{const n=Math.abs(e[0]-t[0]),o=Math.abs(e[1]-t[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},ut={area:t=>Math.PI*t.geometry.rx*t.geometry.ry,intersects:(t,e,n)=>{const{cx:o,cy:i,rx:s,ry:r}=t.geometry,a=Math.cos(0),l=Math.sin(0),c=e-o,d=n-i,u=a*c+l*d,p=l*c-a*d;return u*u/(s*s)+p*p/(r*r)<=1}};st(ot.ELLIPSE,ut);const pt={area:t=>0,intersects:(t,e,n,o=2)=>{const[[i,s],[r,a]]=t.geometry.points;return Math.abs((a-s)*e-(r-i)*n+r*s-a*i)/dt([i,s],[r,a])<=o}};st(ot.LINE,pt);const ht={area:t=>{const{polygons:e}=t.geometry;return e.reduce((t,e)=>{const[n,...o]=e.rings;return t+lt(n.points)-o.reduce((t,e)=>t+lt(e.points),0)},0)},intersects:(t,e,n)=>{const{polygons:o}=t.geometry;for(const t of o){const[o,...i]=t.rings;if(ct(o.points,e,n)){let t=!1;for(const o of i)if(ct(o.points,e,n)){t=!0;break}if(!t)return!0}}return!1}},gt=t=>{const e=t.reduce((t,e)=>[...t,...e.rings[0].points],[]);return at(e)},ft=t=>t.rings.map(t=>((t,e=!0)=>{let n="M ";return t.forEach(([t,e],o)=>{n+=0===o?`${t},${e}`:` L ${t},${e}`}),e&&(n+=" Z"),n})(t.points)).join(" ");st(ot.MULTIPOLYGON,ht);const mt={area:t=>{const e=t.geometry.points;return lt(e)},intersects:(t,e,n)=>{const o=t.geometry.points;return ct(o,e,n)}};st(ot.POLYGON,mt);const yt={area:t=>{const e=t.geometry;if(!e.closed||e.points.length<3)return 0;const n=$t(e.points,e.closed);return lt(n)},intersects:(t,e,n,o=2)=>{const i=t.geometry;if(i.closed){const t=$t(i.points,i.closed);return ct(t,e,n)}return vt(i,[e,n],o)}},$t=(t,e=!1)=>{const n=[];for(let o=0;o<t.length;o++){const i=t[o],s=t[(o+1)%t.length];if(n.push(i.point),(o<t.length-1||e)&&("CURVE"===i.type||"CURVE"==s.type)){const t=wt(i.point,"CURVE"===i.type&&i.outHandle||i.point,"CURVE"===s.type&&s.inHandle||s.point,s.point,10);n.push(...t.slice(1))}}return n},wt=(t,e,n,o,i=10)=>{const s=[];for(let r=0;r<=i;r++){const a=r/i,l=Math.pow(1-a,3)*t[0]+3*Math.pow(1-a,2)*a*e[0]+3*(1-a)*Math.pow(a,2)*n[0]+Math.pow(a,3)*o[0],c=Math.pow(1-a,3)*t[1]+3*Math.pow(1-a,2)*a*e[1]+3*(1-a)*Math.pow(a,2)*n[1]+Math.pow(a,3)*o[1];s.push([l,c])}return s},vt=(t,e,n)=>{for(let o=0;o<t.points.length-1;o++){const i=t.points[o],s=t.points[o+1];if("CURVE"===i.type||"CURVE"===s.type){const t=wt(i.point,"CURVE"===i.type&&i.outHandle||i.point,"CURVE"===s.type&&s.inHandle||s.point,s.point,20);for(let o=0;o<t.length-1;o++)if(bt(e,t[o],t[o+1])<=n)return!0}else if(bt(e,i.point,s.point)<=n)return!0}return!1},bt=(t,e,n)=>{const[o,i]=t,[s,r]=e,[a,l]=n,c=a-s,d=l-r,u=Math.sqrt(c*c+d*d);if(0===u)return Math.sqrt((o-s)*(o-s)+(i-r)*(i-r));const p=((o-s)*c+(i-r)*d)/(u*u);return p<=0?Math.sqrt((o-s)*(o-s)+(i-r)*(i-r)):p>=1?Math.sqrt((o-a)*(o-a)+(i-l)*(i-l)):Math.abs((l-r)*o-(a-s)*i+a*r-l*s)/u};st(ot.POLYLINE,yt),st(ot.RECTANGLE,{area:t=>t.geometry.w*t.geometry.h,intersects:(t,e,n)=>e>=t.geometry.x&&e<=t.geometry.x+t.geometry.w&&n>=t.geometry.y&&n<=t.geometry.y+t.geometry.h});const xt=t=>Et(t.target),Et=t=>{var e,n;return void 0!==(null==t?void 0:t.annotation)&&void 0!==(null==(n=null==(e=null==t?void 0:t.selector)?void 0:e.geometry)?void 0:n.bounds)},At=[];for(let t=0;t<256;++t)At.push((t+256).toString(16).slice(1));let _t;const Mt=new Uint8Array(16),St={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Tt(t,e,n){return St.randomUUID&&!t?St.randomUUID():function(t){var e;const n=(t=t||{}).random??(null==(e=t.rng)?void 0:e.call(t))??function(){if(!_t){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");_t=crypto.getRandomValues.bind(crypto)}return _t(Mt)}();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=15&n[6]|64,n[8]=63&n[8]|128,function(t,e=0){return(At[t[e+0]]+At[t[e+1]]+At[t[e+2]]+At[t[e+3]]+"-"+At[t[e+4]]+At[t[e+5]]+"-"+At[t[e+6]]+At[t[e+7]]+"-"+At[t[e+8]]+At[t[e+9]]+"-"+At[t[e+10]]+At[t[e+11]]+At[t[e+12]]+At[t[e+13]]+At[t[e+14]]+At[t[e+15]]).toLowerCase()}(n)}(t)}var Lt=Object.prototype.hasOwnProperty;function Ot(t,e){var n,o;if(t===e)return!0;if(t&&e&&(n=t.constructor)===e.constructor){if(n===Date)return t.getTime()===e.getTime();if(n===RegExp)return t.toString()===e.toString();if(n===Array){if((o=t.length)===e.length)for(;o--&&Ot(t[o],e[o]););return-1===o}if(!n||"object"==typeof t){for(n in o=0,t)if(Lt.call(t,n)&&++o&&!Lt.call(e,n)||!(n in e)||!Ot(t[n],e[n]))return!1;return Object.keys(e).length===o}}return t!=t&&e!=e}Symbol("clean");let It=[],kt=0,Bt=t=>{let e=[],n={get:()=>(n.lc||n.listen(()=>{})(),n.value),lc:0,listen:t=>(n.lc=e.push(t),()=>{for(let e=kt+4;e<It.length;)It[e]===t?It.splice(e,4):e+=4;let o=e.indexOf(t);~o&&(e.splice(o,1),--n.lc||n.off())}),notify(t,o){let i=!It.length;for(let i of e)It.push(i,n.value,t,o);if(i){for(kt=0;kt<It.length;kt+=4)It[kt](It[kt+1],It[kt+2],It[kt+3]);It.length=0}},off(){},set(t){let e=n.value;e!==t&&(n.value=t,n.notify(e))},subscribe(t){let e=n.listen(t);return t(n.value),e},value:t};return n};var Ct=(t=>(t.EDIT="EDIT",t.SELECT="SELECT",t.NONE="NONE",t))(Ct||{});const Yt={selected:[]},Vt=(t,e,n)=>{const o=n?n.serialize(t):t;return"function"==typeof e?e(o):e||"EDIT"},Dt=[];for(let t=0;t<256;++t)Dt.push((t+256).toString(16).slice(1));let Nt;const Rt=new Uint8Array(16),Ut={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Xt(t,e,n){return Ut.randomUUID&&!t?Ut.randomUUID():function(t){var e;const n=(t=t||{}).random??(null==(e=t.rng)?void 0:e.call(t))??function(){if(!Nt){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Nt=crypto.getRandomValues.bind(crypto)}return Nt(Rt)}();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=15&n[6]|64,n[8]=63&n[8]|128,function(t,e=0){return(Dt[t[e+0]]+Dt[t[e+1]]+Dt[t[e+2]]+Dt[t[e+3]]+"-"+Dt[t[e+4]]+Dt[t[e+5]]+"-"+Dt[t[e+6]]+Dt[t[e+7]]+"-"+Dt[t[e+8]]+Dt[t[e+9]]+"-"+Dt[t[e+10]]+Dt[t[e+11]]+Dt[t[e+12]]+Dt[t[e+13]]+Dt[t[e+14]]+Dt[t[e+15]]).toLowerCase()}(n)}(t)}const Pt=t=>{const e=t=>{const e={...t};return t.created&&"string"==typeof t.created&&(e.created=new Date(t.created)),t.updated&&"string"==typeof t.updated&&(e.updated=new Date(t.updated)),e};return{...t,bodies:(t.bodies||[]).map(e),target:e(t.target)}},Ht=(t,e)=>!Ot(t.target,e.target),jt=(t,e)=>{const n=((t,e)=>{const n=new Set(t.bodies.map(t=>t.id));return e.bodies.filter(t=>!n.has(t.id))})(t,e),o=((t,e)=>{const n=new Set(e.bodies.map(t=>t.id));return t.bodies.filter(t=>!n.has(t.id))})(t,e),i=((t,e)=>e.bodies.map(e=>{const n=t.bodies.find(t=>t.id===e.id);return{newBody:e,oldBody:n&&!Ot(n,e)?n:void 0}}).filter(({oldBody:t})=>t).map(({oldBody:t,newBody:e})=>({oldBody:t,newBody:e})))(t,e);return{oldValue:t,newValue:e,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:Ht(t,e)?{oldTarget:t.target,newTarget:e.target}:void 0}};var Gt=(t=>(t.LOCAL="LOCAL",t.REMOTE="REMOTE",t.SILENT="SILENT",t))(Gt||{});const qt=t=>{const e=void 0===t.id?Xt():t.id;return{...t,id:e,bodies:void 0===t.bodies?[]:t.bodies.map(t=>({...t,annotation:e})),target:{...t.target,annotation:e}}};let Ft=()=>({emit(t,...e){for(let n=this.events[t]||[],o=0,i=n.length;o<i;o++)n[o](...e)},events:{},on(t,e){var n;return((n=this.events)[t]||(n[t]=[])).push(e),()=>{var n;this.events[t]=null==(n=this.events[t])?void 0:n.filter(t=>e!==t)}}});let Wt=t=>crypto.getRandomValues(new Uint8Array(t)),zt=(t,e=21)=>((t,e,n)=>{let o=(2<<Math.log2(t.length-1))-1,i=-~(1.6*o*e/t.length);return(s=e)=>{let r="";for(;;){let e=n(i),a=0|i;for(;a--;)if(r+=t[e[a]&o]||"",r.length>=s)return r}}})(t,0|e,Wt);((t=21)=>{let e="",n=crypto.getRandomValues(new Uint8Array(t|=0));for(;t--;)e+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[t]]})();const Kt=[],Jt=(t,e)=>{const n="function"==typeof e?e(t):e;if(n){const{fill:t,fillOpacity:e,stroke:o,strokeWidth:i,strokeOpacity:s}=n;let r="";return t&&(r+=`fill:${t};`),e||0===e?r+=`fill-opacity:${e};`:t&&(r+="fill-opacity:0.25;"),o&&(r+=`stroke:${o};`,r+=`stroke-width:${i||"1"};`,r+=`stroke-opacity:${s||"1"};`),r}},Zt=(t,e=0)=>{const{minX:n,minY:o,maxX:i,maxY:s}=t;return{x:n-e,y:o-e,w:i-n+2*e,h:s-o+2*e}},Qt=!(typeof window>"u"||typeof navigator>"u")&&("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0),te=t=>({}),ee=t=>({grab:t[0]});function ne(t){let e,n,o,i;const s=t[8].default,a=function(t,e,n,o){if(t){const i=u(t,e,n,o);return t[0](i)}}(s,t,t[7],ee);return{c(){e=$("g"),a&&a.c(),E(e,"class","a9s-annotation selected")},m(s,r){f(s,e,r),a&&a.m(e,null),n=!0,o||(i=[x(e,"pointerup",t[2]),x(e,"pointermove",t[1])],o=!0)},p(t,[e]){a&&a.p&&(!n||128&e)&&function(t,e,n,o,i,s){if(i){const r=u(e,n,o,s);t.p(r,i)}}(a,s,t,t[7],n?function(t,e,n,o){if(t[2]&&o){const i=t[2](o(n));if(void 0===e.dirty)return i;if("object"==typeof i){const t=[],n=Math.max(e.dirty.length,i.length);for(let o=0;o<n;o+=1)t[o]=e.dirty[o]|i[o];return t}return e.dirty|i}return e.dirty}(s,t[7],e,te):function(t){if(t.ctx.length>32){const e=[],n=t.ctx.length/32;for(let t=0;t<n;t++)e[t]=-1;return e}return-1}(t[7]),ee)},i(t){n||(W(a,t),n=!0)},o(t){z(a,t),n=!1},d(t){t&&m(e),a&&a.d(t),o=!1,r(i)}}}function oe(t,e,n){let{$$slots:o={},$$scope:i}=e;const s=L();let r,a,l,{shape:c}=e,{editor:d}=e,{transform:u}=e,{svgEl:p}=e;return t.$$set=t=>{"shape"in t&&n(3,c=t.shape),"editor"in t&&n(4,d=t.editor),"transform"in t&&n(5,u=t.transform),"svgEl"in t&&n(6,p=t.svgEl),"$$scope"in t&&n(7,i=t.$$scope)},[t=>e=>{if(r=t,p){const{left:t,top:n}=p.getBoundingClientRect(),o=e.clientX-t,i=e.clientY-n;a=u.elementToImage(o,i)}else{const{offsetX:t,offsetY:n}=e;a=u.elementToImage(t,n)}l=c,e.target.setPointerCapture(e.pointerId),s("grab",e)},t=>{if(r){const[e,o]=u.elementToImage(t.offsetX,t.offsetY),i=[e-a[0],o-a[1]];n(3,c=d(l,r,i)),s("change",c)}},t=>{t.target.releasePointerCapture(t.pointerId),r=void 0,l=c,s("release",t)},c,d,u,p,i,o]}class ie extends et{constructor(t){super(),tt(this,t,oe,ne,l,{shape:3,editor:4,transform:5,svgEl:6})}}function se(t){let e,n,o,i,s,a,l,c,d=t[3]&&ae(t);return{c(){e=$("g"),n=$("circle"),d&&d.c(),i=$("circle"),E(n,"class","a9s-handle-buffer svelte-qtyc7s"),E(n,"cx",t[0]),E(n,"cy",t[1]),E(n,"r",o=t[5]+6/t[2]),E(n,"role","button"),E(n,"tabindex","0"),E(i,"class",s=h("a9s-handle-dot"+(t[3]?" selected":""))+" svelte-qtyc7s"),E(i,"cx",t[0]),E(i,"cy",t[1]),E(i,"r",t[5]),E(e,"class",a=`a9s-handle ${t[8].class||""}`.trim())},m(o,s){f(o,e,s),g(e,n),d&&d.m(e,null),g(e,i),l||(c=[x(n,"dblclick",t[12]),x(n,"pointerenter",t[13]),x(n,"pointerleave",t[14]),x(n,"pointerdown",t[15]),x(n,"pointerdown",t[6]),x(n,"pointerup",t[16]),x(n,"pointerup",t[7])],l=!0)},p(t,r){1&r&&E(n,"cx",t[0]),2&r&&E(n,"cy",t[1]),36&r&&o!==(o=t[5]+6/t[2])&&E(n,"r",o),t[3]?d?d.p(t,r):(d=ae(t),d.c(),d.m(e,i)):d&&(d.d(1),d=null),8&r&&s!==(s=h("a9s-handle-dot"+(t[3]?" selected":""))+" svelte-qtyc7s")&&E(i,"class",s),1&r&&E(i,"cx",t[0]),2&r&&E(i,"cy",t[1]),32&r&&E(i,"r",t[5]),256&r&&a!==(a=`a9s-handle ${t[8].class||""}`.trim())&&E(e,"class",a)},d(t){t&&m(e),d&&d.d(),l=!1,r(c)}}}function re(t){let e,n,o,i,s,a,l,c,d;return{c(){e=$("g"),n=$("circle"),i=$("circle"),a=$("circle"),E(n,"cx",t[0]),E(n,"cy",t[1]),E(n,"r",o=10*t[5]),E(n,"class","a9s-touch-halo"),A(n,"touched",t[4]),E(i,"cx",t[0]),E(i,"cy",t[1]),E(i,"r",s=t[5]+10/t[2]),E(i,"class","a9s-handle-buffer svelte-qtyc7s"),E(i,"role","button"),E(i,"tabindex","0"),E(a,"class","a9s-handle-dot"),E(a,"cx",t[0]),E(a,"cy",t[1]),E(a,"r",l=t[5]+2/t[2]),E(e,"class","a9s-touch-handle")},m(o,s){f(o,e,s),g(e,n),g(e,i),g(e,a),c||(d=[x(i,"dblclick",t[9]),x(i,"pointerdown",t[10]),x(i,"pointerdown",t[6]),x(i,"pointerup",t[11]),x(i,"pointerup",t[7])],c=!0)},p(t,e){1&e&&E(n,"cx",t[0]),2&e&&E(n,"cy",t[1]),32&e&&o!==(o=10*t[5])&&E(n,"r",o),16&e&&A(n,"touched",t[4]),1&e&&E(i,"cx",t[0]),2&e&&E(i,"cy",t[1]),36&e&&s!==(s=t[5]+10/t[2])&&E(i,"r",s),1&e&&E(a,"cx",t[0]),2&e&&E(a,"cy",t[1]),36&e&&l!==(l=t[5]+2/t[2])&&E(a,"r",l)},d(t){t&&m(e),c=!1,r(d)}}}function ae(t){let e,n;return{c(){e=$("circle"),E(e,"class","a9s-handle-selected"),E(e,"cx",t[0]),E(e,"cy",t[1]),E(e,"r",n=t[5]+8/t[2])},m(t,n){f(t,e,n)},p(t,o){1&o&&E(e,"cx",t[0]),2&o&&E(e,"cy",t[1]),36&o&&n!==(n=t[5]+8/t[2])&&E(e,"r",n)},d(t){t&&m(e)}}}function le(t){let e,o=(Qt?re:se)(t);return{c(){o.c(),e=b()},m(t,n){o.m(t,n),f(t,e,n)},p(t,[e]){o.p(t,e)},i:n,o:n,d(t){t&&m(e),o.d(t)}}}function ce(t,e,n){let i,{x:s}=e,{y:r}=e,{scale:a}=e,{selected:l}=e,c=!1;return t.$$set=t=>{n(8,e=o(o({},e),p(t))),"x"in t&&n(0,s=t.x),"y"in t&&n(1,r=t.y),"scale"in t&&n(2,a=t.scale),"selected"in t&&n(3,l=t.selected)},t.$$.update=()=>{4&t.$$.dirty&&n(5,i=4/a)},e=p(e),[s,r,a,l,c,i,t=>{"touch"===t.pointerType&&n(4,c=!0)},()=>n(4,c=!1),e,function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)}]}class de extends et{constructor(t){super(),tt(this,t,ce,le,l,{x:0,y:1,scale:2,selected:3})}}function ue(t){let e,n,o,i,s,a,l;return{c(){e=$("g"),n=$("circle"),i=$("circle"),s=$("circle"),E(n,"class","a9s-polygon-midpoint-buffer svelte-12ykj76"),E(n,"cx",t[0]),E(n,"cy",t[1]),E(n,"r",o=1.75*t[2]),E(i,"class","a9s-polygon-midpoint-outer svelte-12ykj76"),E(i,"cx",t[0]),E(i,"cy",t[1]),E(i,"r",t[2]),E(s,"class","a9s-polygon-midpoint-inner svelte-12ykj76"),E(s,"cx",t[0]),E(s,"cy",t[1]),E(s,"r",t[2]),E(e,"class","a9s-polygon-midpoint svelte-12ykj76")},m(o,r){f(o,e,r),g(e,n),g(e,i),g(e,s),a||(l=[x(n,"pointerdown",t[5]),x(n,"pointerdown",t[3])],a=!0)},p(t,e){1&e&&E(n,"cx",t[0]),2&e&&E(n,"cy",t[1]),4&e&&o!==(o=1.75*t[2])&&E(n,"r",o),1&e&&E(i,"cx",t[0]),2&e&&E(i,"cy",t[1]),4&e&&E(i,"r",t[2]),1&e&&E(s,"cx",t[0]),2&e&&E(s,"cy",t[1]),4&e&&E(s,"r",t[2])},d(t){t&&m(e),a=!1,r(l)}}}function pe(t){let e;return{c(){e=$("circle"),E(e,"cx",t[0]),E(e,"cy",t[1]),E(e,"r",t[2])},m(t,n){f(t,e,n)},p(t,n){1&n&&E(e,"cx",t[0]),2&n&&E(e,"cy",t[1]),4&n&&E(e,"r",t[2])},d(t){t&&m(e)}}}function he(t){let e,o=(Qt?pe:ue)(t);return{c(){o.c(),e=b()},m(t,n){o.m(t,n),f(t,e,n)},p(t,[e]){o.p(t,e)},i:n,o:n,d(t){t&&m(e),o.d(t)}}}function ge(t,e,n){let o,{x:i}=e,{y:s}=e,{scale:r}=e;return t.$$set=t=>{"x"in t&&n(0,i=t.x),"y"in t&&n(1,s=t.y),"scale"in t&&n(4,r=t.scale)},t.$$.update=()=>{16&t.$$.dirty&&n(2,o=4/r)},[i,s,o,t=>{t.pointerType},r,function(e){O.call(this,t,e)}]}class fe extends et{constructor(t){super(),tt(this,t,ge,he,l,{x:0,y:1,scale:4})}}function me(t){const e=t.slice(),n=e[10][e[6]];return e[28]=n.point,e}function ye(t,e,n){const o=t.slice();return o[28]=e[n],o[30]=n,o}function $e(t){const e=t.slice(),n=e[10][e[6]];return e[28]=n.point,e}function we(t){const e=t.slice(),n=e[10][e[6]];return e[28]=n.point,e}function ve(t){let e,n,o,i;return{c(){e=$("circle"),E(e,"cx",n=t[28][0]),E(e,"cy",o=t[28][1]),E(e,"r",i=Me/t[3]),E(e,"class","svelte-1h2slbm")},m(t,n){f(t,e,n)},p(t,s){1088&s[0]&&n!==(n=t[28][0])&&E(e,"cx",n),1088&s[0]&&o!==(o=t[28][1])&&E(e,"cy",o),8&s[0]&&i!==(i=Me/t[3])&&E(e,"r",i)},d(t){t&&m(e)}}}function be(t){let e,n,o,i,s,r,a,l,c,d;return{c(){e=$("mask"),n=$("rect"),a=$("circle"),E(n,"x",o=t[9].x),E(n,"y",i=t[9].y),E(n,"width",s=t[9].w),E(n,"height",r=t[9].h),E(n,"class","svelte-1h2slbm"),E(a,"cx",l=t[28][0]),E(a,"cy",c=t[28][1]),E(a,"r",d=Me/t[3]),E(a,"class","svelte-1h2slbm"),E(e,"id",`${t[19]}-inner`),E(e,"class","a9s-polygon-editor-mask svelte-1h2slbm")},m(t,o){f(t,e,o),g(e,n),g(e,a)},p(t,e){512&e[0]&&o!==(o=t[9].x)&&E(n,"x",o),512&e[0]&&i!==(i=t[9].y)&&E(n,"y",i),512&e[0]&&s!==(s=t[9].w)&&E(n,"width",s),512&e[0]&&r!==(r=t[9].h)&&E(n,"height",r),1088&e[0]&&l!==(l=t[28][0])&&E(a,"cx",l),1088&e[0]&&c!==(c=t[28][1])&&E(a,"cy",c),8&e[0]&&d!==(d=Me/t[3])&&E(a,"r",d)},d(t){t&&m(e)}}}function xe(t){let e,n;return e=new de({props:{class:"a9s-corner-handle",x:t[28][0],y:t[28][1],scale:t[3],selected:t[8].includes(t[30])}}),e.$on("pointerenter",t[11]),e.$on("pointerleave",t[12]),e.$on("pointerdown",t[15]),e.$on("pointerdown",function(){a(t[27](`HANDLE-${t[30]}`))&&t[27](`HANDLE-${t[30]}`).apply(this,arguments)}),e.$on("pointerup",t[16](t[30])),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(n,o){t=n;const i={};32&o[0]&&(i.x=t[28][0]),32&o[0]&&(i.y=t[28][1]),8&o[0]&&(i.scale=t[3]),256&o[0]&&(i.selected=t[8].includes(t[30])),e.$set(i)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function Ee(t){let e,n;return e=new fe({props:{x:t[28][0],y:t[28][1],scale:t[3]}}),e.$on("pointerdown",function(){a(t[18](t[6]))&&t[18](t[6]).apply(this,arguments)}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(n,o){t=n;const i={};1088&o[0]&&(i.x=t[28][0]),1088&o[0]&&(i.y=t[28][1]),8&o[0]&&(i.scale=t[3]),e.$set(i)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function Ae(t){let e,n,o,i,s,l,c,d,u,p,h,w,A,_,M,S,T,L,O,I,k,B=void 0!==t[6]&&!t[7]&&ve(we(t)),C=void 0!==t[6]&&!t[7]&&be($e(t)),Y=K(t[5].points),V=[];for(let e=0;e<Y.length;e+=1)V[e]=xe(ye(t,Y,e));const D=t=>z(V[t],1,1,()=>{V[t]=null});let N=void 0!==t[6]&&!t[7]&&Ee(me(t));return{c(){e=$("defs"),n=$("mask"),o=$("rect"),d=$("polygon"),B&&B.c(),C&&C.c(),p=v(),h=$("polygon"),A=v(),_=$("polygon"),S=v();for(let t=0;t<V.length;t+=1)V[t].c();T=v(),N&&N.c(),L=b(),E(o,"x",i=t[9].x),E(o,"y",s=t[9].y),E(o,"width",l=t[9].w),E(o,"height",c=t[9].h),E(o,"class","svelte-1h2slbm"),E(d,"points",u=t[5].points.map(Se).join(" ")),E(d,"class","svelte-1h2slbm"),E(n,"id",`${t[19]}-outer`),E(n,"class","a9s-polygon-editor-mask svelte-1h2slbm"),E(h,"class","a9s-outer"),E(h,"mask",`url(#${t[19]}-outer)`),E(h,"points",w=t[5].points.map(Te).join(" ")),E(_,"class","a9s-inner a9s-shape-handle"),E(_,"mask",`url(#${t[19]}-inner)`),E(_,"style",t[1]),E(_,"points",M=t[5].points.map(Le).join(" "))},m(i,s){f(i,e,s),g(e,n),g(n,o),g(n,d),B&&B.m(n,null),C&&C.m(e,null),f(i,p,s),f(i,h,s),f(i,A,s),f(i,_,s),f(i,S,s);for(let t=0;t<V.length;t+=1)V[t]&&V[t].m(i,s);f(i,T,s),N&&N.m(i,s),f(i,L,s),O=!0,I||(k=[x(h,"pointerup",t[14]),x(h,"pointerdown",function(){a(t[27]("SHAPE"))&&t[27]("SHAPE").apply(this,arguments)}),x(_,"pointermove",t[13]),x(_,"pointerup",t[14]),x(_,"pointerdown",function(){a(t[27]("SHAPE"))&&t[27]("SHAPE").apply(this,arguments)})],I=!0)},p(r,a){if(t=r,(!O||512&a[0]&&i!==(i=t[9].x))&&E(o,"x",i),(!O||512&a[0]&&s!==(s=t[9].y))&&E(o,"y",s),(!O||512&a[0]&&l!==(l=t[9].w))&&E(o,"width",l),(!O||512&a[0]&&c!==(c=t[9].h))&&E(o,"height",c),(!O||32&a[0]&&u!==(u=t[5].points.map(Se).join(" ")))&&E(d,"points",u),void 0===t[6]||t[7]?B&&(B.d(1),B=null):B?B.p(we(t),a):(B=ve(we(t)),B.c(),B.m(n,null)),void 0===t[6]||t[7]?C&&(C.d(1),C=null):C?C.p($e(t),a):(C=be($e(t)),C.c(),C.m(e,null)),(!O||32&a[0]&&w!==(w=t[5].points.map(Te).join(" ")))&&E(h,"points",w),(!O||2&a[0])&&E(_,"style",t[1]),(!O||32&a[0]&&M!==(M=t[5].points.map(Le).join(" ")))&&E(_,"points",M),134322472&a[0]){let e;for(Y=K(t[5].points),e=0;e<Y.length;e+=1){const n=ye(t,Y,e);V[e]?(V[e].p(n,a),W(V[e],1)):(V[e]=xe(n),V[e].c(),W(V[e],1),V[e].m(T.parentNode,T))}for(q(),e=Y.length;e<V.length;e+=1)D(e);F()}void 0===t[6]||t[7]?N&&(q(),z(N,1,1,()=>{N=null}),F()):N?(N.p(me(t),a),192&a[0]&&W(N,1)):(N=Ee(me(t)),N.c(),W(N,1),N.m(L.parentNode,L))},i(t){if(!O){for(let t=0;t<Y.length;t+=1)W(V[t]);W(N),O=!0}},o(t){V=V.filter(Boolean);for(let t=0;t<V.length;t+=1)z(V[t]);z(N),O=!1},d(t){t&&(m(e),m(p),m(h),m(A),m(_),m(S),m(T),m(L)),B&&B.d(),C&&C.d(),y(V,t),N&&N.d(t),I=!1,r(k)}}}function _e(t){let e,n;return e=new ie({props:{shape:t[0],transform:t[2],editor:t[17],svgEl:t[4],$$slots:{default:[Ae,({grab:t})=>({27:t}),({grab:t})=>[t?134217728:0]]},$$scope:{ctx:t}}}),e.$on("change",t[20]),e.$on("grab",t[21]),e.$on("release",t[22]),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};1&n[0]&&(o.shape=t[0]),4&n[0]&&(o.transform=t[2]),16&n[0]&&(o.svgEl=t[4]),134219754&n[0]|1&n[1]&&(o.$$scope={dirty:n,ctx:t}),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}const Me=4.5,Se=t=>t.join(","),Te=t=>t.join(","),Le=t=>t.join(",");function Oe(t,e,n){let o,i,s;const r=L();let a,l,{shape:c}=e,{computedStyle:d}=e,{transform:u}=e,{viewportScale:p=1}=e,{svgEl:h}=e,g=!1,f=[];const m=t=>{if(f.length>0||!i.some(t=>t.visible))return void n(6,a=void 0);const[e,s]=u.elementToImage(t.offsetX,t.offsetY),r=t=>Math.pow(t[0]-e,2)+Math.pow(t[1]-s,2),l=o.points.reduce((t,e)=>r(e)<r(t)?e:t),c=i.filter(t=>t.visible).reduce((t,e)=>r(e.point)<r(t.point)?e:t),d=Math.pow(1e3/p,2);r(l)<d||r(c.point)<d?n(6,a=i.indexOf(c)):n(6,a=void 0)},y=()=>{document.activeElement!==h&&h.focus()};T(()=>{if(Qt)return;const t=t=>{("Delete"===t.key||"Backspace"===t.key)&&(t.preventDefault(),(()=>{if(o.points.length-f.length<3)return;const t=o.points.filter((t,e)=>!f.includes(e)),e=at(t);r("change",{...c,geometry:{points:t,bounds:e}}),n(8,f=[])})())};return h.addEventListener("pointermove",m),h.addEventListener("keydown",t),()=>{h.removeEventListener("pointermove",m),h.removeEventListener("keydown",t)}});const $=`polygon-mask-${Math.random().toString(36).substring(2,12)}`;return t.$$set=t=>{"shape"in t&&n(0,c=t.shape),"computedStyle"in t&&n(1,d=t.computedStyle),"transform"in t&&n(2,u=t.transform),"viewportScale"in t&&n(3,p=t.viewportScale),"svgEl"in t&&n(4,h=t.svgEl)},t.$$.update=()=>{1&t.$$.dirty[0]&&n(5,o=c.geometry),40&t.$$.dirty[0]&&n(10,i=Qt?[]:o.points.map((t,e)=>{const n=e===o.points.length-1?o.points[0]:o.points[e+1],i=(t[0]+n[0])/2,s=(t[1]+n[1])/2;return{point:[i,s],visible:Math.sqrt(Math.pow(n[0]-i,2)+Math.pow(n[1]-s,2))>12/p}})),40&t.$$.dirty[0]&&n(9,s=Zt(o.bounds,Me/p))},[c,d,u,p,h,o,a,g,f,s,i,()=>n(7,g=!0),()=>n(7,g=!1),m,()=>{n(8,f=[]),y()},t=>{n(7,g=!0),t.preventDefault(),t.stopPropagation(),l=performance.now()},t=>e=>{if(!l||Qt||performance.now()-l>250)return;const o=f.includes(t);e.metaKey||e.ctrlKey||e.shiftKey?n(8,f=o?f.filter(e=>e!==t):[...f,t]):o&&f.length>1?n(8,f=[t]):n(8,f=o?[]:[t]),y()},(t,e,n)=>{let o;y();const i=t.geometry;o=f.length>1?i.points.map(([t,e],o)=>f.includes(o)?[t+n[0],e+n[1]]:[t,e]):"SHAPE"===e?i.points.map(([t,e])=>[t+n[0],e+n[1]]):i.points.map(([t,o],i)=>e===`HANDLE-${i}`?[t+n[0],o+n[1]]:[t,o]);const s=at(o);return{...t,geometry:{points:o,bounds:s}}},t=>async e=>{e.stopPropagation();const n=[...o.points.slice(0,t+1),i[t].point,...o.points.slice(t+1)],s=at(n);r("change",{...c,geometry:{points:n,bounds:s}}),await N();const a=[...document.querySelectorAll(".a9s-handle")][t+1];if(null!=a&&a.firstChild){const t=new PointerEvent("pointerdown",{bubbles:!0,cancelable:!0,clientX:e.clientX,clientY:e.clientY,pointerId:e.pointerId,pointerType:e.pointerType,isPrimary:e.isPrimary,buttons:e.buttons});a.firstChild.dispatchEvent(t)}},$,function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)}]}function Ie(t){let e,n,o,i,s,l,c,d,u,p,h,y,w,b,A,_,M,S,T,L,O,I,k,B,C,Y,V,D,N,R,U,X,P,H,j,G,q,F,K,tt,et,nt,ot,it,st,rt,at,lt,ct,dt,ut,pt,ht,gt,ft;return rt=new de({props:{class:"a9s-corner-handle-topleft",x:t[5].x,y:t[5].y,scale:t[3]}}),rt.$on("pointerdown",function(){a(t[12]("TOP_LEFT"))&&t[12]("TOP_LEFT").apply(this,arguments)}),lt=new de({props:{class:"a9s-corner-handle-topright",x:t[5].x+t[5].w,y:t[5].y,scale:t[3]}}),lt.$on("pointerdown",function(){a(t[12]("TOP_RIGHT"))&&t[12]("TOP_RIGHT").apply(this,arguments)}),dt=new de({props:{class:"a9s-corner-handle-bottomright",x:t[5].x+t[5].w,y:t[5].y+t[5].h,scale:t[3]}}),dt.$on("pointerdown",function(){a(t[12]("BOTTOM_RIGHT"))&&t[12]("BOTTOM_RIGHT").apply(this,arguments)}),pt=new de({props:{class:"a9s-corner-handle-bottomleft",x:t[5].x,y:t[5].y+t[5].h,scale:t[3]}}),pt.$on("pointerdown",function(){a(t[12]("BOTTOM_LEFT"))&&t[12]("BOTTOM_LEFT").apply(this,arguments)}),{c(){e=$("defs"),n=$("mask"),o=$("rect"),d=$("rect"),w=v(),b=$("rect"),T=v(),L=$("rect"),C=v(),Y=$("rect"),R=v(),U=$("rect"),j=v(),G=$("rect"),tt=v(),et=$("rect"),st=v(),J(rt.$$.fragment),at=v(),J(lt.$$.fragment),ct=v(),J(dt.$$.fragment),ut=v(),J(pt.$$.fragment),E(o,"class","rect-mask-bg svelte-1njczvj"),E(o,"x",i=t[6].x),E(o,"y",s=t[6].y),E(o,"width",l=t[6].w),E(o,"height",c=t[6].h),E(d,"class","rect-mask-fg svelte-1njczvj"),E(d,"x",u=t[5].x),E(d,"y",p=t[5].y),E(d,"width",h=t[5].w),E(d,"height",y=t[5].h),E(n,"id",t[8]),E(n,"class","a9s-rectangle-editor-mask svelte-1njczvj"),E(b,"class","a9s-outer"),E(b,"mask",`url(#${t[8]})`),E(b,"x",A=t[5].x),E(b,"y",_=t[5].y),E(b,"width",M=t[5].w),E(b,"height",S=t[5].h),E(L,"class","a9s-inner a9s-shape-handle"),E(L,"style",t[1]),E(L,"x",O=t[5].x),E(L,"y",I=t[5].y),E(L,"width",k=t[5].w),E(L,"height",B=t[5].h),E(Y,"class","a9s-edge-handle a9s-edge-handle-top"),E(Y,"x",V=t[5].x),E(Y,"y",D=t[5].y),E(Y,"height",1),E(Y,"width",N=t[5].w),E(U,"class","a9s-edge-handle a9s-edge-handle-right"),E(U,"x",X=t[5].x+t[5].w),E(U,"y",P=t[5].y),E(U,"height",H=t[5].h),E(U,"width",1),E(G,"class","a9s-edge-handle a9s-edge-handle-bottom"),E(G,"x",q=t[5].x),E(G,"y",F=t[5].y+t[5].h),E(G,"height",1),E(G,"width",K=t[5].w),E(et,"class","a9s-edge-handle a9s-edge-handle-left"),E(et,"x",nt=t[5].x),E(et,"y",ot=t[5].y),E(et,"height",it=t[5].h),E(et,"width",1)},m(i,s){f(i,e,s),g(e,n),g(n,o),g(n,d),f(i,w,s),f(i,b,s),f(i,T,s),f(i,L,s),f(i,C,s),f(i,Y,s),f(i,R,s),f(i,U,s),f(i,j,s),f(i,G,s),f(i,tt,s),f(i,et,s),f(i,st,s),Z(rt,i,s),f(i,at,s),Z(lt,i,s),f(i,ct,s),Z(dt,i,s),f(i,ut,s),Z(pt,i,s),ht=!0,gt||(ft=[x(b,"pointerdown",function(){a(t[12]("SHAPE"))&&t[12]("SHAPE").apply(this,arguments)}),x(L,"pointerdown",function(){a(t[12]("SHAPE"))&&t[12]("SHAPE").apply(this,arguments)}),x(Y,"pointerdown",function(){a(t[12]("TOP"))&&t[12]("TOP").apply(this,arguments)}),x(U,"pointerdown",function(){a(t[12]("RIGHT"))&&t[12]("RIGHT").apply(this,arguments)}),x(G,"pointerdown",function(){a(t[12]("BOTTOM"))&&t[12]("BOTTOM").apply(this,arguments)}),x(et,"pointerdown",function(){a(t[12]("LEFT"))&&t[12]("LEFT").apply(this,arguments)})],gt=!0)},p(e,n){t=e,(!ht||64&n&&i!==(i=t[6].x))&&E(o,"x",i),(!ht||64&n&&s!==(s=t[6].y))&&E(o,"y",s),(!ht||64&n&&l!==(l=t[6].w))&&E(o,"width",l),(!ht||64&n&&c!==(c=t[6].h))&&E(o,"height",c),(!ht||32&n&&u!==(u=t[5].x))&&E(d,"x",u),(!ht||32&n&&p!==(p=t[5].y))&&E(d,"y",p),(!ht||32&n&&h!==(h=t[5].w))&&E(d,"width",h),(!ht||32&n&&y!==(y=t[5].h))&&E(d,"height",y),(!ht||32&n&&A!==(A=t[5].x))&&E(b,"x",A),(!ht||32&n&&_!==(_=t[5].y))&&E(b,"y",_),(!ht||32&n&&M!==(M=t[5].w))&&E(b,"width",M),(!ht||32&n&&S!==(S=t[5].h))&&E(b,"height",S),(!ht||2&n)&&E(L,"style",t[1]),(!ht||32&n&&O!==(O=t[5].x))&&E(L,"x",O),(!ht||32&n&&I!==(I=t[5].y))&&E(L,"y",I),(!ht||32&n&&k!==(k=t[5].w))&&E(L,"width",k),(!ht||32&n&&B!==(B=t[5].h))&&E(L,"height",B),(!ht||32&n&&V!==(V=t[5].x))&&E(Y,"x",V),(!ht||32&n&&D!==(D=t[5].y))&&E(Y,"y",D),(!ht||32&n&&N!==(N=t[5].w))&&E(Y,"width",N),(!ht||32&n&&X!==(X=t[5].x+t[5].w))&&E(U,"x",X),(!ht||32&n&&P!==(P=t[5].y))&&E(U,"y",P),(!ht||32&n&&H!==(H=t[5].h))&&E(U,"height",H),(!ht||32&n&&q!==(q=t[5].x))&&E(G,"x",q),(!ht||32&n&&F!==(F=t[5].y+t[5].h))&&E(G,"y",F),(!ht||32&n&&K!==(K=t[5].w))&&E(G,"width",K),(!ht||32&n&&nt!==(nt=t[5].x))&&E(et,"x",nt),(!ht||32&n&&ot!==(ot=t[5].y))&&E(et,"y",ot),(!ht||32&n&&it!==(it=t[5].h))&&E(et,"height",it);const r={};32&n&&(r.x=t[5].x),32&n&&(r.y=t[5].y),8&n&&(r.scale=t[3]),rt.$set(r);const a={};32&n&&(a.x=t[5].x+t[5].w),32&n&&(a.y=t[5].y),8&n&&(a.scale=t[3]),lt.$set(a);const g={};32&n&&(g.x=t[5].x+t[5].w),32&n&&(g.y=t[5].y+t[5].h),8&n&&(g.scale=t[3]),dt.$set(g);const f={};32&n&&(f.x=t[5].x),32&n&&(f.y=t[5].y+t[5].h),8&n&&(f.scale=t[3]),pt.$set(f)},i(t){ht||(W(rt.$$.fragment,t),W(lt.$$.fragment,t),W(dt.$$.fragment,t),W(pt.$$.fragment,t),ht=!0)},o(t){z(rt.$$.fragment,t),z(lt.$$.fragment,t),z(dt.$$.fragment,t),z(pt.$$.fragment,t),ht=!1},d(t){t&&(m(e),m(w),m(b),m(T),m(L),m(C),m(Y),m(R),m(U),m(j),m(G),m(tt),m(et),m(st),m(at),m(ct),m(ut)),Q(rt,t),Q(lt,t),Q(dt,t),Q(pt,t),gt=!1,r(ft)}}}function ke(t){let e,n;return e=new ie({props:{shape:t[0],transform:t[2],editor:t[7],svgEl:t[4],$$slots:{default:[Ie,({grab:t})=>({12:t}),({grab:t})=>t?4096:0]},$$scope:{ctx:t}}}),e.$on("grab",t[9]),e.$on("change",t[10]),e.$on("release",t[11]),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,[n]){const o={};1&n&&(o.shape=t[0]),4&n&&(o.transform=t[2]),16&n&&(o.svgEl=t[4]),12394&n&&(o.$$scope={dirty:n,ctx:t}),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function Be(t,e,n){let o,i,{shape:s}=e,{computedStyle:r}=e,{transform:a}=e,{viewportScale:l=1}=e,{svgEl:c}=e;const d=`rect-mask-${Math.random().toString(36).substring(2,12)}`;return t.$$set=t=>{"shape"in t&&n(0,s=t.shape),"computedStyle"in t&&n(1,r=t.computedStyle),"transform"in t&&n(2,a=t.transform),"viewportScale"in t&&n(3,l=t.viewportScale),"svgEl"in t&&n(4,c=t.svgEl)},t.$$.update=()=>{1&t.$$.dirty&&n(5,o=s.geometry),40&t.$$.dirty&&n(6,i=Zt(o.bounds,2/l))},[s,r,a,l,c,o,i,(t,e,n)=>{const o=t.geometry.bounds;let[i,s]=[o.minX,o.minY],[r,a]=[o.maxX,o.maxY];const[l,c]=n;if("SHAPE"===e)i+=l,r+=l,s+=c,a+=c;else{switch(e){case"TOP":case"TOP_LEFT":case"TOP_RIGHT":s+=c;break;case"BOTTOM":case"BOTTOM_LEFT":case"BOTTOM_RIGHT":a+=c}switch(e){case"LEFT":case"TOP_LEFT":case"BOTTOM_LEFT":i+=l;break;case"RIGHT":case"TOP_RIGHT":case"BOTTOM_RIGHT":r+=l}}const d=Math.min(i,r),u=Math.min(s,a),p=Math.abs(r-i),h=Math.abs(a-s);return{...t,geometry:{x:d,y:u,w:p,h,bounds:{minX:d,minY:u,maxX:d+p,maxY:u+h}}}},d,function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)}]}var Ce=Object.prototype.hasOwnProperty;function Ye(t,e){var n,o;if(t===e)return!0;if(t&&e&&(n=t.constructor)===e.constructor){if(n===Date)return t.getTime()===e.getTime();if(n===RegExp)return t.toString()===e.toString();if(n===Array){if((o=t.length)===e.length)for(;o--&&Ye(t[o],e[o]););return-1===o}if(!n||"object"==typeof t){for(n in o=0,t)if(Ce.call(t,n)&&++o&&!Ce.call(e,n)||!(n in e)||!Ye(t[n],e[n]))return!1;return Object.keys(e).length===o}}return t!=t&&e!=e}function Ve(t){const e=t.slice(),n=e[10][e[6]];return e[29]=n.point,e}function De(t,e,n){const o=t.slice();return o[30]=e[n],o[32]=n,o}function Ne(t,e,n){const o=t.slice();return o[33]=e[n],o[35]=n,o}function Re(t,e,n){const o=t.slice();return o[29]=e[n],o[37]=n,o}function Ue(t){const e=t.slice(),n=e[10][e[6]];return e[29]=n.point,e}function Xe(t){const e=t.slice(),n=e[10][e[6]];return e[29]=n.point,e}function Pe(t){let e,n,o,i;return{c(){e=$("circle"),E(e,"cx",n=t[29][0]),E(e,"cy",o=t[29][1]),E(e,"r",i=Ke/t[3]),E(e,"class","svelte-1vxo6dc")},m(t,n){f(t,e,n)},p(t,s){1088&s[0]&&n!==(n=t[29][0])&&E(e,"cx",n),1088&s[0]&&o!==(o=t[29][1])&&E(e,"cy",o),8&s[0]&&i!==(i=Ke/t[3])&&E(e,"r",i)},d(t){t&&m(e)}}}function He(t){let e,n,o,i,s,r,a,l,c,d;return{c(){e=$("mask"),n=$("rect"),a=$("circle"),E(n,"x",o=t[9].x),E(n,"y",i=t[9].y),E(n,"width",s=t[9].w),E(n,"height",r=t[9].h),E(n,"class","svelte-1vxo6dc"),E(a,"cx",l=t[29][0]),E(a,"cy",c=t[29][1]),E(a,"r",d=Ke/t[3]),E(a,"class","svelte-1vxo6dc"),E(e,"id",`${t[18]}-${t[32]}-inner`),E(e,"class","a9s-multipolygon-editor-mask svelte-1vxo6dc")},m(t,o){f(t,e,o),g(e,n),g(e,a)},p(t,e){512&e[0]&&o!==(o=t[9].x)&&E(n,"x",o),512&e[0]&&i!==(i=t[9].y)&&E(n,"y",i),512&e[0]&&s!==(s=t[9].w)&&E(n,"width",s),512&e[0]&&r!==(r=t[9].h)&&E(n,"height",r),1088&e[0]&&l!==(l=t[29][0])&&E(a,"cx",l),1088&e[0]&&c!==(c=t[29][1])&&E(a,"cy",c),8&e[0]&&d!==(d=Ke/t[3])&&E(a,"r",d)},d(t){t&&m(e)}}}function je(t){let e,n;function o(...e){return t[19](t[32],t[35],t[37],...e)}return e=new de({props:{class:"a9s-corner-handle",x:t[29][0],y:t[29][1],scale:t[3],selected:t[8].some(o)}}),e.$on("pointerenter",t[11]),e.$on("pointerleave",t[12]),e.$on("pointerdown",t[14]),e.$on("pointerdown",function(){a(t[28](`HANDLE-${t[32]}-${t[35]}-${t[37]}`))&&t[28](`HANDLE-${t[32]}-${t[35]}-${t[37]}`).apply(this,arguments)}),e.$on("pointerup",t[15](t[32],t[35],t[37])),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(n,i){t=n;const s={};32&i[0]&&(s.x=t[29][0]),32&i[0]&&(s.y=t[29][1]),8&i[0]&&(s.scale=t[3]),256&i[0]&&(s.selected=t[8].some(o)),e.$set(s)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function Ge(t){let e,n,o=K(t[33].points),i=[];for(let e=0;e<o.length;e+=1)i[e]=je(Re(t,o,e));const s=t=>z(i[t],1,1,()=>{i[t]=null});return{c(){for(let t=0;t<i.length;t+=1)i[t].c();e=b()},m(t,o){for(let e=0;e<i.length;e+=1)i[e]&&i[e].m(t,o);f(t,e,o),n=!0},p(t,n){if(268491048&n[0]){let r;for(o=K(t[33].points),r=0;r<o.length;r+=1){const s=Re(t,o,r);i[r]?(i[r].p(s,n),W(i[r],1)):(i[r]=je(s),i[r].c(),W(i[r],1),i[r].m(e.parentNode,e))}for(q(),r=o.length;r<i.length;r+=1)s(r);F()}},i(t){if(!n){for(let t=0;t<o.length;t+=1)W(i[t]);n=!0}},o(t){i=i.filter(Boolean);for(let t=0;t<i.length;t+=1)z(i[t]);n=!1},d(t){t&&m(e),y(i,t)}}}function qe(t){let e,n,o,i,s,l,c,d,u,p,h,w,v,b,A,_,M,S=void 0!==t[6]&&!t[7]&&Pe(Xe(t)),T=void 0!==t[6]&&!t[7]&&He(Ue(t)),L=K(t[30].rings),O=[];for(let e=0;e<L.length;e+=1)O[e]=Ge(Ne(t,L,e));const I=t=>z(O[t],1,1,()=>{O[t]=null});return{c(){e=$("g"),n=$("defs"),o=$("mask"),i=$("rect"),u=$("path"),S&&S.c(),T&&T.c(),h=$("path"),v=$("path");for(let t=0;t<O.length;t+=1)O[t].c();E(i,"x",s=t[9].x),E(i,"y",l=t[9].y),E(i,"width",c=t[9].w),E(i,"height",d=t[9].h),E(i,"class","svelte-1vxo6dc"),E(u,"d",p=ft(t[30])),E(u,"class","svelte-1vxo6dc"),E(o,"id",`${t[18]}-${t[32]}-outer`),E(o,"class","a9s-multipolygon-editor-mask svelte-1vxo6dc"),E(h,"class","a9s-outer"),E(h,"mask",`url(#${t[18]}-${t[32]}-outer)`),E(h,"fill-rule","evenodd"),E(h,"d",w=ft(t[30])),E(v,"class","a9s-inner"),E(v,"mask",`url(#${t[18]}-${t[32]}-inner)`),E(v,"style",t[1]),E(v,"fill-rule","evenodd"),E(v,"d",b=ft(t[30]))},m(s,r){f(s,e,r),g(e,n),g(n,o),g(o,i),g(o,u),S&&S.m(o,null),T&&T.m(n,null),g(e,h),g(e,v);for(let t=0;t<O.length;t+=1)O[t]&&O[t].m(e,null);A=!0,_||(M=[x(h,"pointerup",t[13]),x(h,"pointerdown",function(){a(t[28]("SHAPE"))&&t[28]("SHAPE").apply(this,arguments)}),x(v,"pointerup",t[13]),x(v,"pointerdown",function(){a(t[28]("SHAPE"))&&t[28]("SHAPE").apply(this,arguments)})],_=!0)},p(r,a){if(t=r,(!A||512&a[0]&&s!==(s=t[9].x))&&E(i,"x",s),(!A||512&a[0]&&l!==(l=t[9].y))&&E(i,"y",l),(!A||512&a[0]&&c!==(c=t[9].w))&&E(i,"width",c),(!A||512&a[0]&&d!==(d=t[9].h))&&E(i,"height",d),(!A||32&a[0]&&p!==(p=ft(t[30])))&&E(u,"d",p),void 0===t[6]||t[7]?S&&(S.d(1),S=null):S?S.p(Xe(t),a):(S=Pe(Xe(t)),S.c(),S.m(o,null)),void 0===t[6]||t[7]?T&&(T.d(1),T=null):T?T.p(Ue(t),a):(T=He(Ue(t)),T.c(),T.m(n,null)),(!A||32&a[0]&&w!==(w=ft(t[30])))&&E(h,"d",w),(!A||2&a[0])&&E(v,"style",t[1]),(!A||32&a[0]&&b!==(b=ft(t[30])))&&E(v,"d",b),268491048&a[0]){let n;for(L=K(t[30].rings),n=0;n<L.length;n+=1){const o=Ne(t,L,n);O[n]?(O[n].p(o,a),W(O[n],1)):(O[n]=Ge(o),O[n].c(),W(O[n],1),O[n].m(e,null))}for(q(),n=L.length;n<O.length;n+=1)I(n);F()}},i(t){if(!A){for(let t=0;t<L.length;t+=1)W(O[t]);A=!0}},o(t){O=O.filter(Boolean);for(let t=0;t<O.length;t+=1)z(O[t]);A=!1},d(t){t&&m(e),S&&S.d(),T&&T.d(),y(O,t),_=!1,r(M)}}}function Fe(t){let e,n;return e=new fe({props:{x:t[29][0],y:t[29][1],scale:t[3]}}),e.$on("pointerdown",function(){a(t[17](t[6]))&&t[17](t[6]).apply(this,arguments)}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(n,o){t=n;const i={};1088&o[0]&&(i.x=t[29][0]),1088&o[0]&&(i.y=t[29][1]),8&o[0]&&(i.scale=t[3]),e.$set(i)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function We(t){let e,n,o,i=K(t[5].polygons),s=[];for(let e=0;e<i.length;e+=1)s[e]=qe(De(t,i,e));const r=t=>z(s[t],1,1,()=>{s[t]=null});let a=void 0!==t[6]&&!t[7]&&Fe(Ve(t));return{c(){for(let t=0;t<s.length;t+=1)s[t].c();e=v(),a&&a.c(),n=b()},m(t,i){for(let e=0;e<s.length;e+=1)s[e]&&s[e].m(t,i);f(t,e,i),a&&a.m(t,i),f(t,n,i),o=!0},p(t,o){if(268763114&o[0]){let n;for(i=K(t[5].polygons),n=0;n<i.length;n+=1){const r=De(t,i,n);s[n]?(s[n].p(r,o),W(s[n],1)):(s[n]=qe(r),s[n].c(),W(s[n],1),s[n].m(e.parentNode,e))}for(q(),n=i.length;n<s.length;n+=1)r(n);F()}void 0===t[6]||t[7]?a&&(q(),z(a,1,1,()=>{a=null}),F()):a?(a.p(Ve(t),o),192&o[0]&&W(a,1)):(a=Fe(Ve(t)),a.c(),W(a,1),a.m(n.parentNode,n))},i(t){if(!o){for(let t=0;t<i.length;t+=1)W(s[t]);W(a),o=!0}},o(t){s=s.filter(Boolean);for(let t=0;t<s.length;t+=1)z(s[t]);z(a),o=!1},d(t){t&&(m(e),m(n)),y(s,t),a&&a.d(t)}}}function ze(t){let e,n;return e=new ie({props:{shape:t[0],transform:t[2],editor:t[16],svgEl:t[4],$$slots:{default:[We,({grab:t})=>({28:t}),({grab:t})=>[t?268435456:0]]},$$scope:{ctx:t}}}),e.$on("change",t[20]),e.$on("grab",t[21]),e.$on("release",t[22]),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};1&n[0]&&(o.shape=t[0]),4&n[0]&&(o.transform=t[2]),16&n[0]&&(o.svgEl=t[4]),268437482&n[0]|128&n[1]&&(o.$$scope={dirty:n,ctx:t}),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}const Ke=4.5;function Je(t,e,n){let o,i,s;const r=L();let a,l,{shape:c}=e,{computedStyle:d}=e,{transform:u}=e,{viewportScale:p=1}=e,{svgEl:h}=e,g=!1,f=[];const m=t=>{if(f.length>0||!i.some(t=>t.visible))return void n(6,a=void 0);const[e,s]=u.elementToImage(t.offsetX,t.offsetY),r=t=>Math.pow(t[0]-e,2)+Math.pow(t[1]-s,2),l=(t=>t.polygons.reduce((t,e)=>[...t,...e.rings.reduce((t,e)=>[...t,...e.points],[])],[]))(o).reduce((t,e)=>r(e)<r(t)?e:t),c=i.filter(t=>t.visible).reduce((t,e)=>r(e.point)<r(t.point)?e:t),d=Math.pow(1e3/p,2);r(l)<d||r(c.point)<d?n(6,a=i.indexOf(c)):n(6,a=void 0)},y=()=>{document.activeElement!==h&&h.focus()},$=()=>{const t=o.polygons.map((t,e)=>{if(f.some(t=>t.polygon===e)){const n=t.rings.map((t,n)=>{const o=f.filter(t=>t.polygon===e&&t.ring===n);return o.length&&t.points.length-o.length>=3?{points:t.points.filter((t,e)=>!o.some(t=>t.point===e))}:t});return{rings:n,bounds:at(n[0].points)}}return t});!Ye(o.polygons,t)&&(r("change",{...c,geometry:{polygons:t,bounds:gt(t)}}),n(8,f=[]))};T(()=>{if(Qt)return;const t=t=>{("Delete"===t.key||"Backspace"===t.key)&&(t.preventDefault(),$())};return h.addEventListener("pointermove",m),h.addEventListener("keydown",t),()=>{h.removeEventListener("pointermove",m),h.removeEventListener("keydown",t)}});const w=`polygon-mask-${Math.random().toString(36).substring(2,12)}`;return t.$$set=t=>{"shape"in t&&n(0,c=t.shape),"computedStyle"in t&&n(1,d=t.computedStyle),"transform"in t&&n(2,u=t.transform),"viewportScale"in t&&n(3,p=t.viewportScale),"svgEl"in t&&n(4,h=t.svgEl)},t.$$.update=()=>{1&t.$$.dirty[0]&&n(5,o=c.geometry),40&t.$$.dirty[0]&&n(10,i=Qt?[]:((t,e)=>t.polygons.reduce((t,n,o)=>[...t,...n.rings.reduce((t,n,i)=>[...t,...n.points.map((t,s)=>{const r=s===n.points.length-1?n.points[0]:n.points[s+1],a=(t[0]+r[0])/2,l=(t[1]+r[1])/2;return{point:[a,l],visible:Math.sqrt(Math.pow(r[0]-a,2)+Math.pow(r[1]-l,2))>12/e,elementIdx:o,ringIdx:i,pointIdx:s}})],[])],[]))(o,p)),40&t.$$.dirty[0]&&n(9,s=Zt(o.bounds,Ke/p))},[c,d,u,p,h,o,a,g,f,s,i,()=>n(7,g=!0),()=>n(7,g=!1),()=>{n(8,f=[]),y()},t=>{n(7,g=!0),t.preventDefault(),t.stopPropagation(),l=performance.now()},(t,e,o)=>i=>{if(!l||Qt||performance.now()-l>250)return;const s=n=>n.polygon===t&&n.ring===e&&n.point===o,r=f.some(s);i.metaKey||i.ctrlKey||i.shiftKey?n(8,f=r?f.filter(t=>!s(t)):[...f,{polygon:t,ring:e,point:o}]):r&&f.length>1?n(8,f=[{polygon:t,ring:e,point:o}]):n(8,f=r?[]:[{polygon:t,ring:e,point:o}]),y()},(t,e,n)=>{y();const o=t.geometry.polygons;let i;if("SHAPE"===e)i=o.map(t=>{const e=t.rings.map((t,e)=>({points:t.points.map((t,e)=>[t[0]+n[0],t[1]+n[1]])}));return{rings:e,bounds:at(e[0].points)}});else{const[t,s,r,a]=e.split("-").map(t=>parseInt(t));i=o.map((t,e)=>{if(e===s){const e=t.rings.map((t,e)=>e===r?{points:t.points.map((t,e)=>e===a?[t[0]+n[0],t[1]+n[1]]:t)}:t);return{rings:e,bounds:at(e[0].points)}}return t})}return{...t,geometry:{polygons:i,bounds:gt(i)}}},t=>async e=>{e.stopPropagation();const n=i[t],s=o.polygons.map((t,e)=>{if(e===n.elementIdx){const e=t.rings.map((t,e)=>e===n.ringIdx?{points:[...t.points.slice(0,n.pointIdx+1),n.point,...t.points.slice(n.pointIdx+1)]}:t);return{rings:e,bounds:at(e[0].points)}}return t});r("change",{...c,geometry:{polygons:s,bounds:gt(s)}}),await N();const a=[...document.querySelectorAll(".a9s-handle")][t+1];if(null!=a&&a.firstChild){const t=new PointerEvent("pointerdown",{bubbles:!0,cancelable:!0,clientX:e.clientX,clientY:e.clientY,pointerId:e.pointerId,pointerType:e.pointerType,isPrimary:e.isPrimary,buttons:e.buttons});a.firstChild.dispatchEvent(t)}},w,(t,e,n,{polygon:o,ring:i,point:s})=>o===t&&i===e&&s===n,function(e){O.call(this,t,e)},function(e){O.call(this,t,e)},function(e){O.call(this,t,e)}]}const Ze=new Map([[ot.RECTANGLE,class extends et{constructor(t){super(),tt(this,t,Be,ke,l,{shape:0,computedStyle:1,transform:2,viewportScale:3,svgEl:4})}}],[ot.POLYGON,class extends et{constructor(t){super(),tt(this,t,Oe,_e,l,{shape:0,computedStyle:1,transform:2,viewportScale:3,svgEl:4},null,[-1,-1])}}],[ot.MULTIPOLYGON,class extends et{constructor(t){super(),tt(this,t,Je,ze,l,{shape:0,computedStyle:1,transform:2,viewportScale:3,svgEl:4},null,[-1,-1])}}]]),Qe=t=>Ze.get(t.type);function tn(t,e,n){let o;const i=L();let s,{annotation:r}=e,{editor:a}=e,{style:l}=e,{target:c}=e,{transform:d}=e,{viewportScale:u}=e;return T(()=>(n(6,s=new a({target:c,props:{shape:r.target.selector,computedStyle:o,transform:d,viewportScale:u,svgEl:c.closest("svg")}})),s.$on("change",t=>{s.$$set({shape:t.detail}),i("change",t.detail)}),s.$on("grab",t=>i("grab",t.detail)),s.$on("release",t=>i("release",t.detail)),()=>{s.$destroy()})),t.$$set=t=>{"annotation"in t&&n(0,r=t.annotation),"editor"in t&&n(1,a=t.editor),"style"in t&&n(2,l=t.style),"target"in t&&n(3,c=t.target),"transform"in t&&n(4,d=t.transform),"viewportScale"in t&&n(5,u=t.viewportScale)},t.$$.update=()=>{5&t.$$.dirty&&n(7,o=Jt(r,l)),65&t.$$.dirty&&r&&(null==s||s.$set({shape:r.target.selector})),80&t.$$.dirty&&s&&s.$set({transform:d}),96&t.$$.dirty&&s&&s.$set({viewportScale:u}),192&t.$$.dirty&&s&&o&&s.$set({computedStyle:o})},[r,a,l,c,d,u,s,o]}class en extends et{constructor(t){super(),tt(this,t,tn,null,l,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function nn(t,e,n){const o=L();let i,{drawingMode:s}=e,{target:r}=e,{tool:a}=e,{transform:l}=e,{viewportScale:c}=e;return T(()=>{const t=r.closest("svg"),e=[];return n(5,i=new a({target:r,props:{addEventListener:(n,o,i)=>{null==t||t.addEventListener(n,o,i),e.push(()=>null==t?void 0:t.removeEventListener(n,o,i))},drawingMode:s,transform:l,viewportScale:c}})),i.$on("create",t=>o("create",t.detail)),()=>{e.forEach(t=>t()),i.$destroy()}}),t.$$set=t=>{"drawingMode"in t&&n(0,s=t.drawingMode),"target"in t&&n(1,r=t.target),"tool"in t&&n(2,a=t.tool),"transform"in t&&n(3,l=t.transform),"viewportScale"in t&&n(4,c=t.viewportScale)},t.$$.update=()=>{40&t.$$.dirty&&i&&i.$set({transform:l}),48&t.$$.dirty&&i&&i.$set({viewportScale:c})},[s,r,a,l,c,i]}class on extends et{constructor(t){super(),tt(this,t,nn,null,l,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function sn(t){let e,n,o,i,s,r,a,l,c,d;return{c(){e=$("defs"),n=$("mask"),o=$("rect"),l=$("rect"),c=$("rect"),d=$("rect"),E(o,"class","rect-mask-bg svelte-1a76qe7"),E(o,"x",i=t[1]-t[5]),E(o,"y",s=t[2]-t[5]),E(o,"width",r=t[3]+2*t[5]),E(o,"height",a=t[4]+2*t[5]),E(l,"class","rect-mask-fg svelte-1a76qe7"),E(l,"x",t[1]),E(l,"y",t[2]),E(l,"width",t[3]),E(l,"height",t[4]),E(n,"id",t[6]),E(n,"class","a9s-rubberband-rectangle-mask svelte-1a76qe7"),E(c,"class","a9s-outer"),E(c,"mask",`url(#${t[6]})`),E(c,"x",t[1]),E(c,"y",t[2]),E(c,"width",t[3]),E(c,"height",t[4]),E(d,"class","a9s-inner"),E(d,"x",t[1]),E(d,"y",t[2]),E(d,"width",t[3]),E(d,"height",t[4])},m(t,i){f(t,e,i),g(e,n),g(n,o),g(n,l),f(t,c,i),f(t,d,i)},p(t,e){34&e&&i!==(i=t[1]-t[5])&&E(o,"x",i),36&e&&s!==(s=t[2]-t[5])&&E(o,"y",s),40&e&&r!==(r=t[3]+2*t[5])&&E(o,"width",r),48&e&&a!==(a=t[4]+2*t[5])&&E(o,"height",a),2&e&&E(l,"x",t[1]),4&e&&E(l,"y",t[2]),8&e&&E(l,"width",t[3]),16&e&&E(l,"height",t[4]),2&e&&E(c,"x",t[1]),4&e&&E(c,"y",t[2]),8&e&&E(c,"width",t[3]),16&e&&E(c,"height",t[4]),2&e&&E(d,"x",t[1]),4&e&&E(d,"y",t[2]),8&e&&E(d,"width",t[3]),16&e&&E(d,"height",t[4])},d(t){t&&(m(e),m(c),m(d))}}}function rn(t){let e,o=t[0]&&sn(t);return{c(){e=$("g"),o&&o.c(),E(e,"class","a9s-annotation a9s-rubberband")},m(t,n){f(t,e,n),o&&o.m(e,null)},p(t,[n]){t[0]?o?o.p(t,n):(o=sn(t),o.c(),o.m(e,null)):o&&(o.d(1),o=null)},i:n,o:n,d(t){t&&m(e),o&&o.d()}}}function an(t,e,n){let o;const i=L();let s,r,a,l,c,d,u,{addEventListener:p}=e,{drawingMode:h}=e,{transform:g}=e,{viewportScale:f=1}=e;const m=t=>{const e=t;s=performance.now(),"drag"===h&&(n(0,r=g.elementToImage(e.offsetX,e.offsetY)),a=r,n(1,l=r[0]),n(2,c=r[1]),n(3,d=1),n(4,u=1))},y=t=>{const e=t;r&&(a=g.elementToImage(e.offsetX,e.offsetY),n(1,l=Math.min(a[0],r[0])),n(2,c=Math.min(a[1],r[1])),n(3,d=Math.abs(a[0]-r[0])),n(4,u=Math.abs(a[1]-r[1])))},$=t=>{const e=t,o=performance.now()-s;if("click"===h){if(o>300)return;r?w():(n(0,r=g.elementToImage(e.offsetX,e.offsetY)),a=r,n(1,l=r[0]),n(2,c=r[1]),n(3,d=1),n(4,u=1))}else r&&(o>300||d*u>100?(e.stopPropagation(),w()):(n(0,r=void 0),a=void 0))},w=()=>{if(d*u>15){const t={type:ot.RECTANGLE,geometry:{bounds:{minX:l,minY:c,maxX:l+d,maxY:c+u},x:l,y:c,w:d,h:u}};i("create",t)}n(0,r=void 0),a=void 0};T(()=>{p("pointerdown",m),p("pointermove",y),p("pointerup",$,!0)});const v=`rect-mask-${Math.random().toString(36).substring(2,12)}`;return t.$$set=t=>{"addEventListener"in t&&n(7,p=t.addEventListener),"drawingMode"in t&&n(8,h=t.drawingMode),"transform"in t&&n(9,g=t.transform),"viewportScale"in t&&n(10,f=t.viewportScale)},t.$$.update=()=>{1024&t.$$.dirty&&n(5,o=2/f)},[r,l,c,d,u,o,v,p,h,g,f]}function ln(t){const e=t.slice(),n=e[2].map(t=>t.join(",")).join(" ");return e[19]=n,e}function cn(t){let e,n,o,i,s,r,a,l,c,d,u,p,h,y,w=t[1]&&dn(t);return{c(){e=$("defs"),n=$("mask"),o=$("rect"),l=$("polygon"),d=$("polygon"),p=$("polygon"),w&&w.c(),y=b(),E(o,"x",i=t[3].x),E(o,"y",s=t[3].y),E(o,"width",r=t[3].w),E(o,"height",a=t[3].h),E(o,"class","svelte-18wrg3t"),E(l,"points",c=t[19]),E(l,"class","svelte-18wrg3t"),E(n,"id",t[5]),E(n,"class","a9s-rubberband-polygon-mask svelte-18wrg3t"),E(d,"class","a9s-outer"),E(d,"mask",`url(#${t[5]})`),E(d,"points",u=t[19]),E(p,"class","a9s-inner"),E(p,"points",h=t[19])},m(t,i){f(t,e,i),g(e,n),g(n,o),g(n,l),f(t,d,i),f(t,p,i),w&&w.m(t,i),f(t,y,i)},p(t,e){8&e&&i!==(i=t[3].x)&&E(o,"x",i),8&e&&s!==(s=t[3].y)&&E(o,"y",s),8&e&&r!==(r=t[3].w)&&E(o,"width",r),8&e&&a!==(a=t[3].h)&&E(o,"height",a),4&e&&c!==(c=t[19])&&E(l,"points",c),4&e&&u!==(u=t[19])&&E(d,"points",u),4&e&&h!==(h=t[19])&&E(p,"points",h),t[1]?w?w.p(t,e):(w=dn(t),w.c(),w.m(y.parentNode,y)):w&&(w.d(1),w=null)},d(t){t&&(m(e),m(d),m(p),m(y)),w&&w.d(t)}}}function dn(t){let e,n,o;return{c(){e=$("circle"),E(e,"class","a9s-handle svelte-18wrg3t"),E(e,"cx",n=t[0][0][0]),E(e,"cy",o=t[0][0][1]),E(e,"r",t[4])},m(t,n){f(t,e,n)},p(t,i){1&i&&n!==(n=t[0][0][0])&&E(e,"cx",n),1&i&&o!==(o=t[0][0][1])&&E(e,"cy",o),16&i&&E(e,"r",t[4])},d(t){t&&m(e)}}}function un(t){let e,o=t[3]&&cn(ln(t));return{c(){e=$("g"),o&&o.c(),E(e,"class","a9s-annotation a9s-rubberband")},m(t,n){f(t,e,n),o&&o.m(e,null)},p(t,[n]){t[3]?o?o.p(ln(t),n):(o=cn(ln(t)),o.c(),o.m(e,null)):o&&(o.d(1),o=null)},i:n,o:n,d(t){t&&m(e),o&&o.d()}}}function pn(t,e,n){let o,i,s;const r=L();let a,l,c,{addEventListener:d}=e,{drawingMode:u}=e,{transform:p}=e,{viewportScale:h=1}=e,g=[],f=!1;const m=t=>{const e=t,{timeStamp:o,offsetX:i,offsetY:s}=e;if(a={timeStamp:o,offsetX:i,offsetY:s},"drag"===u&&0===g.length){const t=p.elementToImage(e.offsetX,e.offsetY);g.push(t),n(10,l=t)}},y=t=>{const e=t;if(c&&clearTimeout(c),g.length>0){if(n(10,l=p.elementToImage(e.offsetX,e.offsetY)),g.length>2){const t=dt(l,g[0])*h;n(1,f=t<20)}"touch"===e.pointerType&&(c=setTimeout(()=>{w()},1500))}},$=t=>{const e=t;if(c&&clearTimeout(c),"click"===u){const t=e.timeStamp-a.timeStamp,o=dt([a.offsetX,a.offsetY],[e.offsetX,e.offsetY]);if(t>300||o>15)return;if(f)v();else if(0===g.length){const t=p.elementToImage(e.offsetX,e.offsetY);g.push(t),n(10,l=t)}else l&&g.push(l)}else{if(!l)return;if(1===g.length&&dt(g[0],l)<=4)return n(0,g=[]),void n(10,l=void 0);e.stopImmediatePropagation(),f?v():g.push(l)}},w=()=>{if(!l)return;const t=g.slice(0,-1);if(t.length<3)return;const e={type:ot.POLYGON,geometry:{bounds:at(g),points:t}};rt(e)>4&&(n(0,g=[]),n(10,l=void 0),r("create",e))},v=()=>{const t={type:ot.POLYGON,geometry:{bounds:at(g),points:[...g]}};n(0,g=[]),n(10,l=void 0),r("create",t)};T(()=>{d("pointerdown",m,!0),d("pointermove",y),d("pointerup",$,!0),d("dblclick",w,!0)});const b=`polygon-mask-${Math.random().toString(36).substring(2,12)}`;return t.$$set=t=>{"addEventListener"in t&&n(6,d=t.addEventListener),"drawingMode"in t&&n(7,u=t.drawingMode),"transform"in t&&n(8,p=t.transform),"viewportScale"in t&&n(9,h=t.viewportScale)},t.$$.update=()=>{512&t.$$.dirty&&n(4,o=4/h),1027&t.$$.dirty&&n(2,i=l?f?g:[...g,l]:[]),516&t.$$.dirty&&n(3,s=i.length>0?Zt(at(i),2/h):void 0)},[g,f,i,s,o,b,d,u,p,h,l]}const hn=new Map([["rectangle",{tool:class extends et{constructor(t){super(),tt(this,t,an,rn,l,{addEventListener:7,drawingMode:8,transform:9,viewportScale:10})}}}],["polygon",{tool:class extends et{constructor(t){super(),tt(this,t,pn,un,l,{addEventListener:6,drawingMode:7,transform:8,viewportScale:9})}}}]]),gn=()=>[...hn.keys()],fn=t=>hn.get(t);function mn(t){let e,o,i,s,r;return{c(){e=$("g"),o=$("ellipse"),s=$("ellipse"),E(o,"class","a9s-outer"),E(o,"style",i=t[1]?"display:none;":void 0),E(o,"cx",t[2]),E(o,"cy",t[3]),E(o,"rx",t[4]),E(o,"ry",t[5]),E(s,"class","a9s-inner"),E(s,"style",t[1]),E(s,"cx",t[2]),E(s,"cy",t[3]),E(s,"rx",t[4]),E(s,"ry",t[5]),E(e,"class","a9s-annotation"),E(e,"data-id",r=t[0].id)},m(t,n){f(t,e,n),g(e,o),g(e,s)},p(t,[n]){2&n&&i!==(i=t[1]?"display:none;":void 0)&&E(o,"style",i),2&n&&E(s,"style",t[1]),1&n&&r!==(r=t[0].id)&&E(e,"data-id",r)},i:n,o:n,d(t){t&&m(e)}}}function yn(t,e,n){let o,{annotation:i}=e,{geom:s}=e,{style:r}=e;const{cx:a,cy:l,rx:c,ry:d}=s;return t.$$set=t=>{"annotation"in t&&n(0,i=t.annotation),"geom"in t&&n(6,s=t.geom),"style"in t&&n(7,r=t.style)},t.$$.update=()=>{129&t.$$.dirty&&n(1,o=Jt(i,r))},[i,o,a,l,c,d,s,r]}class $n extends et{constructor(t){super(),tt(this,t,yn,mn,l,{annotation:0,geom:6,style:7})}}function wn(t){let e,o,i,s,r;return{c(){e=$("g"),o=$("line"),s=$("line"),E(o,"class","a9s-outer"),E(o,"style",i=t[1]?"display:none;":void 0),E(o,"x1",t[2]),E(o,"y1",t[3]),E(o,"x2",t[4]),E(o,"y2",t[5]),E(s,"class","a9s-inner"),E(s,"style",t[1]),E(s,"x1",t[2]),E(s,"y1",t[3]),E(s,"x2",t[4]),E(s,"y2",t[5]),E(e,"class","a9s-annotation"),E(e,"data-id",r=t[0].id)},m(t,n){f(t,e,n),g(e,o),g(e,s)},p(t,[n]){2&n&&i!==(i=t[1]?"display:none;":void 0)&&E(o,"style",i),2&n&&E(s,"style",t[1]),1&n&&r!==(r=t[0].id)&&E(e,"data-id",r)},i:n,o:n,d(t){t&&m(e)}}}function vn(t,e,n){let o,{annotation:i}=e,{geom:s}=e,{style:r}=e;const{points:a}=s,[[l,c],[d,u]]=a;return t.$$set=t=>{"annotation"in t&&n(0,i=t.annotation),"geom"in t&&n(6,s=t.geom),"style"in t&&n(7,r=t.style)},t.$$.update=()=>{129&t.$$.dirty&&n(1,o=Jt(i,r))},[i,o,l,c,d,u,s,r]}class bn extends et{constructor(t){super(),tt(this,t,vn,wn,l,{annotation:0,geom:6,style:7})}}function xn(t,e,n){const o=t.slice();return o[5]=e[n],o}function En(t){let e,n,o;return{c(){e=$("path"),o=$("path"),E(e,"class","a9s-outer"),E(e,"style",n=t[1]?"display:none;":void 0),E(e,"fill-rule","evenodd"),E(e,"d",ft(t[5])),E(o,"class","a9s-inner"),E(o,"style",t[1]),E(o,"fill-rule","evenodd"),E(o,"d",ft(t[5]))},m(t,n){f(t,e,n),f(t,o,n)},p(t,i){2&i&&n!==(n=t[1]?"display:none;":void 0)&&E(e,"style",n),2&i&&E(o,"style",t[1])},d(t){t&&(m(e),m(o))}}}function An(t){let e,o,i=K(t[2]),s=[];for(let e=0;e<i.length;e+=1)s[e]=En(xn(t,i,e));return{c(){e=$("g");for(let t=0;t<s.length;t+=1)s[t].c();E(e,"class","a9s-annotation"),E(e,"data-id",o=t[0].id)},m(t,n){f(t,e,n);for(let t=0;t<s.length;t+=1)s[t]&&s[t].m(e,null)},p(t,[n]){if(6&n){let o;for(i=K(t[2]),o=0;o<i.length;o+=1){const r=xn(t,i,o);s[o]?s[o].p(r,n):(s[o]=En(r),s[o].c(),s[o].m(e,null))}for(;o<s.length;o+=1)s[o].d(1);s.length=i.length}1&n&&o!==(o=t[0].id)&&E(e,"data-id",o)},i:n,o:n,d(t){t&&m(e),y(s,t)}}}function _n(t,e,n){let o,{annotation:i}=e,{geom:s}=e,{style:r}=e;const{polygons:a}=s;return t.$$set=t=>{"annotation"in t&&n(0,i=t.annotation),"geom"in t&&n(3,s=t.geom),"style"in t&&n(4,r=t.style)},t.$$.update=()=>{17&t.$$.dirty&&n(1,o=Jt(i,r))},[i,o,a,s,r]}class Mn extends et{constructor(t){super(),tt(this,t,_n,An,l,{annotation:0,geom:3,style:4})}}function Sn(t){let e,o,i,s,r;return{c(){e=$("g"),o=$("polygon"),s=$("polygon"),E(o,"class","a9s-outer"),E(o,"style",i=t[1]?"display:none;":void 0),E(o,"points",t[2].map(Tn).join(" ")),E(s,"class","a9s-inner"),E(s,"style",t[1]),E(s,"points",t[2].map(Ln).join(" ")),E(e,"class","a9s-annotation"),E(e,"data-id",r=t[0].id)},m(t,n){f(t,e,n),g(e,o),g(e,s)},p(t,[n]){2&n&&i!==(i=t[1]?"display:none;":void 0)&&E(o,"style",i),2&n&&E(s,"style",t[1]),1&n&&r!==(r=t[0].id)&&E(e,"data-id",r)},i:n,o:n,d(t){t&&m(e)}}}const Tn=t=>t.join(","),Ln=t=>t.join(",");function On(t,e,n){let o,{annotation:i}=e,{geom:s}=e,{style:r}=e;const{points:a}=s;return t.$$set=t=>{"annotation"in t&&n(0,i=t.annotation),"geom"in t&&n(3,s=t.geom),"style"in t&&n(4,r=t.style)},t.$$.update=()=>{17&t.$$.dirty&&n(1,o=Jt(i,r))},[i,o,a,s,r]}class In extends et{constructor(t){super(),tt(this,t,On,Sn,l,{annotation:0,geom:3,style:4})}}function kn(t){let e,o,i,s,r,a,l;return{c(){e=$("g"),o=$("path"),r=$("path"),E(o,"class",i=h(`a9s-outer ${t[1]}`)+" svelte-1w0132l"),E(o,"style",s=t[3]?"display:none;":void 0),E(o,"d",t[2]),E(r,"class",a=h(`a9s-inner ${t[1]}`)+" svelte-1w0132l"),E(r,"style",t[3]),E(r,"d",t[2]),E(e,"class","a9s-annotation"),E(e,"data-id",l=t[0].id)},m(t,n){f(t,e,n),g(e,o),g(e,r)},p(t,[n]){2&n&&i!==(i=h(`a9s-outer ${t[1]}`)+" svelte-1w0132l")&&E(o,"class",i),8&n&&s!==(s=t[3]?"display:none;":void 0)&&E(o,"style",s),4&n&&E(o,"d",t[2]),2&n&&a!==(a=h(`a9s-inner ${t[1]}`)+" svelte-1w0132l")&&E(r,"class",a),8&n&&E(r,"style",t[3]),4&n&&E(r,"d",t[2]),1&n&&l!==(l=t[0].id)&&E(e,"data-id",l)},i:n,o:n,d(t){t&&m(e)}}}function Bn(t,e,n){let o,i,s,{annotation:r}=e,{geom:a}=e,{style:l}=e;return t.$$set=t=>{"annotation"in t&&n(0,r=t.annotation),"geom"in t&&n(4,a=t.geom),"style"in t&&n(5,l=t.style)},t.$$.update=()=>{33&t.$$.dirty&&n(3,o=Jt(r,l)),16&t.$$.dirty&&n(2,i=(t=>{if(!t.points||0===t.points.length)return"";const e=[],n=t.points[0];e.push(`M ${n.point[0]} ${n.point[1]}`);for(let n=1;n<t.points.length;n++){const o=t.points[n],i=t.points[n-1];if("CURVE"===o.type||"CURVE"===i.type){const t="CURVE"===i.type&&i.outHandle||i.point,n="CURVE"===o.type&&o.inHandle||o.point,s=o.point;e.push(`C ${t[0]} ${t[1]} ${n[0]} ${n[1]} ${s[0]} ${s[1]}`)}else e.push(`L ${o.point[0]} ${o.point[1]}`)}if(t.closed){const n=t.points[t.points.length-1],o=t.points[0];if("CURVE"===n.type||"CURVE"===o.type){const t=n.outHandle||n.point,i=o.inHandle||o.point,s=o.point;e.push(`C ${t[0]} ${t[1]} ${i[0]} ${i[1]} ${s[0]} ${s[1]}`)}e.push("Z")}return e.join(" ")})(a)),16&t.$$.dirty&&n(1,s=a.closed?"closed":"open")},[r,s,i,o,a,l]}class Cn extends et{constructor(t){super(),tt(this,t,Bn,kn,l,{annotation:0,geom:4,style:5})}}function Yn(t){let e,o,i,s,r;return{c(){e=$("g"),o=$("rect"),s=$("rect"),E(o,"class","a9s-outer"),E(o,"style",i=t[5]?"display:none;":void 0),E(o,"x",t[4]),E(o,"y",t[3]),E(o,"width",t[2]),E(o,"height",t[1]),E(s,"class","a9s-inner"),E(s,"style",t[5]),E(s,"x",t[4]),E(s,"y",t[3]),E(s,"width",t[2]),E(s,"height",t[1]),E(e,"class","a9s-annotation"),E(e,"data-id",r=t[0].id)},m(t,n){f(t,e,n),g(e,o),g(e,s)},p(t,[n]){32&n&&i!==(i=t[5]?"display:none;":void 0)&&E(o,"style",i),16&n&&E(o,"x",t[4]),8&n&&E(o,"y",t[3]),4&n&&E(o,"width",t[2]),2&n&&E(o,"height",t[1]),32&n&&E(s,"style",t[5]),16&n&&E(s,"x",t[4]),8&n&&E(s,"y",t[3]),4&n&&E(s,"width",t[2]),2&n&&E(s,"height",t[1]),1&n&&r!==(r=t[0].id)&&E(e,"data-id",r)},i:n,o:n,d(t){t&&m(e)}}}function Vn(t,e,n){let o,i,s,r,a,{annotation:l}=e,{geom:c}=e,{style:d}=e;return t.$$set=t=>{"annotation"in t&&n(0,l=t.annotation),"geom"in t&&n(6,c=t.geom),"style"in t&&n(7,d=t.style)},t.$$.update=()=>{129&t.$$.dirty&&n(5,o=Jt(l,d)),64&t.$$.dirty&&n(4,({x:i,y:s,w:r,h:a}=c),i,(n(3,s),n(6,c)),(n(2,r),n(6,c)),(n(1,a),n(6,c)))},[l,a,r,s,i,o,c,d]}class Dn extends et{constructor(t){super(),tt(this,t,Vn,Yn,l,{annotation:0,geom:6,style:7})}}const Nn=(t,e)=>{const n=e.createSVGPoint(),o=e.getBoundingClientRect(),i=t.clientX-o.x,s=t.clientY-o.y,{left:r,top:a}=e.getBoundingClientRect();return n.x=i+r,n.y=s+a,n.matrixTransform(e.getScreenCTM().inverse())};function Rn(t,e,n){const o=t.slice();return o[39]=e[n],o}function Un(t,e,n){const o=t.slice();return o[42]=e[n],o}function Xn(t){const e=t.slice(),n=e[42].target.selector;return e[45]=n,e}function Pn(t){let e,o,i=t[42],s=zn(t);return{c(){s.c(),e=b()},m(t,n){s.m(t,n),f(t,e,n),o=!0},p(t,o){131072&o[0]&&l(i,i=t[42])?(q(),z(s,1,1,n),F(),s=zn(t),s.c(),W(s,1),s.m(e.parentNode,e)):s.p(t,o)},i(t){o||(W(s),o=!0)},o(t){z(s),o=!1},d(t){t&&m(e),s.d(t)}}}function Hn(t){let e,n;return e=new bn({props:{annotation:t[42],geom:t[45].geometry,style:t[1]}}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};131072&n[0]&&(o.annotation=t[42]),131072&n[0]&&(o.geom=t[45].geometry),2&n[0]&&(o.style=t[1]),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function jn(t){let e,n;return e=new Cn({props:{annotation:t[42],geom:t[45].geometry,style:t[1]}}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};131072&n[0]&&(o.annotation=t[42]),131072&n[0]&&(o.geom=t[45].geometry),2&n[0]&&(o.style=t[1]),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function Gn(t){let e,n;return e=new Mn({props:{annotation:t[42],geom:t[45].geometry,style:t[1]}}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};131072&n[0]&&(o.annotation=t[42]),131072&n[0]&&(o.geom=t[45].geometry),2&n[0]&&(o.style=t[1]),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function qn(t){let e,n;return e=new In({props:{annotation:t[42],geom:t[45].geometry,style:t[1]}}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};131072&n[0]&&(o.annotation=t[42]),131072&n[0]&&(o.geom=t[45].geometry),2&n[0]&&(o.style=t[1]),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function Fn(t){let e,n;return e=new Dn({props:{annotation:t[42],geom:t[45].geometry,style:t[1]}}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};131072&n[0]&&(o.annotation=t[42]),131072&n[0]&&(o.geom=t[45].geometry),2&n[0]&&(o.style=t[1]),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function Wn(t){var e;let n,o;return n=new $n({props:{annotation:t[42],geom:null==(e=t[45])?void 0:e.geometry,style:t[1]}}),{c(){J(n.$$.fragment)},m(t,e){Z(n,t,e),o=!0},p(t,e){var o;const i={};131072&e[0]&&(i.annotation=t[42]),131072&e[0]&&(i.geom=null==(o=t[45])?void 0:o.geometry),2&e[0]&&(i.style=t[1]),n.$set(i)},i(t){o||(W(n.$$.fragment,t),o=!0)},o(t){z(n.$$.fragment,t),o=!1},d(t){Q(n,t)}}}function zn(t){let e,n,o,i;const s=[Wn,Fn,qn,Gn,jn,Hn],r=[];function a(t,e){var n,o,i,s,r,a;return(null==(n=t[45])?void 0:n.type)===ot.ELLIPSE?0:(null==(o=t[45])?void 0:o.type)===ot.RECTANGLE?1:(null==(i=t[45])?void 0:i.type)===ot.POLYGON?2:(null==(s=t[45])?void 0:s.type)===ot.MULTIPOLYGON?3:(null==(r=t[45])?void 0:r.type)===ot.POLYLINE?4:(null==(a=t[45])?void 0:a.type)===ot.LINE?5:-1}return~(e=a(t))&&(n=r[e]=s[e](t)),{c(){n&&n.c(),o=b()},m(t,n){~e&&r[e].m(t,n),f(t,o,n),i=!0},p(t,i){let l=e;e=a(t),e===l?~e&&r[e].p(t,i):(n&&(q(),z(r[l],1,1,()=>{r[l]=null}),F()),~e?(n=r[e],n?n.p(t,i):(n=r[e]=s[e](t),n.c()),W(n,1),n.m(o.parentNode,o)):n=null)},i(t){i||(W(n),i=!0)},o(t){z(n),i=!1},d(t){t&&m(o),~e&&r[e].d(t)}}}function Kn(t){let e,n,o=xt(t[42])&&!t[10](t[42]),i=o&&Pn(Xn(t));return{c(){i&&i.c(),e=b()},m(t,o){i&&i.m(t,o),f(t,e,o),n=!0},p(t,n){132096&n[0]&&(o=xt(t[42])&&!t[10](t[42])),o?i?(i.p(Xn(t),n),132096&n[0]&&W(i,1)):(i=Pn(Xn(t)),i.c(),W(i,1),i.m(e.parentNode,e)):i&&(q(),z(i,1,1,()=>{i=null}),F())},i(t){n||(W(i),n=!0)},o(t){z(i),n=!1},d(t){t&&m(e),i&&i.d(t)}}}function Jn(t){let e,n,o,i;const s=[Qn,Zn],r=[];function a(t,e){return t[6]?0:t[15]&&t[0]?1:-1}return~(e=a(t))&&(n=r[e]=s[e](t)),{c(){n&&n.c(),o=b()},m(t,n){~e&&r[e].m(t,n),f(t,o,n),i=!0},p(t,i){let l=e;e=a(t),e===l?~e&&r[e].p(t,i):(n&&(q(),z(r[l],1,1,()=>{r[l]=null}),F()),~e?(n=r[e],n?n.p(t,i):(n=r[e]=s[e](t),n.c()),W(n,1),n.m(o.parentNode,o)):n=null)},i(t){i||(W(n),i=!0)},o(t){z(n),i=!1},d(t){t&&m(o),~e&&r[e].d(t)}}}function Zn(t){let e,o,i=`${t[2]}-${t[7]}`,s=to(t);return{c(){s.c(),e=b()},m(t,n){s.m(t,n),f(t,e,n),o=!0},p(t,o){132&o[0]&&l(i,i=`${t[2]}-${t[7]}`)?(q(),z(s,1,1,n),F(),s=to(t),s.c(),W(s,1),s.m(e.parentNode,e)):s.p(t,o)},i(t){o||(W(s),o=!0)},o(t){z(s),o=!1},d(t){t&&m(e),s.d(t)}}}function Qn(t){let e,n,o=K(t[6]),i=[];for(let e=0;e<o.length;e+=1)i[e]=no(Rn(t,o,e));const s=t=>z(i[t],1,1,()=>{i[t]=null});return{c(){for(let t=0;t<i.length;t+=1)i[t].c();e=b()},m(t,o){for(let e=0;e<i.length;e+=1)i[e]&&i[e].m(t,o);f(t,e,o),n=!0},p(t,n){if(8659266&n[0]){let r;for(o=K(t[6]),r=0;r<o.length;r+=1){const s=Rn(t,o,r);i[r]?(i[r].p(s,n),W(i[r],1)):(i[r]=no(s),i[r].c(),W(i[r],1),i[r].m(e.parentNode,e))}for(q(),r=o.length;r<i.length;r+=1)s(r);F()}},i(t){if(!n){for(let t=0;t<o.length;t+=1)W(i[t]);n=!0}},o(t){i=i.filter(Boolean);for(let t=0;t<i.length;t+=1)z(i[t]);n=!1},d(t){t&&m(e),y(i,t)}}}function to(t){let e,n;return e=new on({props:{target:t[8],tool:t[15],drawingMode:t[14],transform:t[13],viewportScale:t[18]}}),e.$on("create",t[22]),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(t,n){const o={};256&n[0]&&(o.target=t[8]),32768&n[0]&&(o.tool=t[15]),16384&n[0]&&(o.drawingMode=t[14]),8192&n[0]&&(o.transform=t[13]),262144&n[0]&&(o.viewportScale=t[18]),e.$set(o)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function eo(t){let e,n;return e=new en({props:{target:t[8],editor:t[39].editor,annotation:t[39].annotation,style:t[1],transform:t[13],viewportScale:t[18]}}),e.$on("change",function(){a(t[23](t[39].annotation))&&t[23](t[39].annotation).apply(this,arguments)}),{c(){J(e.$$.fragment)},m(t,o){Z(e,t,o),n=!0},p(n,o){t=n;const i={};256&o[0]&&(i.target=t[8]),64&o[0]&&(i.editor=t[39].editor),64&o[0]&&(i.annotation=t[39].annotation),2&o[0]&&(i.style=t[1]),8192&o[0]&&(i.transform=t[13]),262144&o[0]&&(i.viewportScale=t[18]),e.$set(i)},i(t){n||(W(e.$$.fragment,t),n=!0)},o(t){z(e.$$.fragment,t),n=!1},d(t){Q(e,t)}}}function no(t){let e,o,i=t[39].annotation.id,s=eo(t);return{c(){s.c(),e=b()},m(t,n){s.m(t,n),f(t,e,n),o=!0},p(t,o){64&o[0]&&l(i,i=t[39].annotation.id)?(q(),z(s,1,1,n),F(),s=eo(t),s.c(),W(s,1),s.m(e.parentNode,e)):s.p(t,o)},i(t){o||(W(s),o=!0)},o(t){z(s),o=!1},d(t){t&&m(e),s.d(t)}}}function oo(t){let e,n,o,i,s,l,c=K(t[17].filter(t[34])),d=[];for(let e=0;e<c.length;e+=1)d[e]=Kn(Un(t,c,e));const u=t=>z(d[t],1,1,()=>{d[t]=null});let p=t[8]&&Jn(t);return{c(){e=$("svg"),n=$("g");for(let t=0;t<d.length;t+=1)d[t].c();o=$("g"),p&&p.c(),E(o,"class","drawing"),E(e,"role","application"),E(e,"tabindex",0),E(e,"class","a9s-annotationlayer"),A(e,"drawing",t[15]),A(e,"editing",t[5]),A(e,"hidden",!t[3]),A(e,"hover",t[16])},m(r,c){f(r,e,c),g(e,n);for(let t=0;t<d.length;t+=1)d[t]&&d[t].m(n,null);g(e,o),p&&p.m(o,null),t[35](o),t[36](e),i=!0,s||(l=[x(e,"pointerup",function(){a(t[11])&&t[11].apply(this,arguments)}),x(e,"pointerdown",function(){a(t[12])&&t[12].apply(this,arguments)}),x(e,"pointermove",t[24])],s=!0)},p(s,r){if(t=s,132098&r[0]){let e;for(c=K(t[17].filter(t[34])),e=0;e<c.length;e+=1){const o=Un(t,c,e);d[e]?(d[e].p(o,r),W(d[e],1)):(d[e]=Kn(o),d[e].c(),W(d[e],1),d[e].m(n,null))}for(q(),e=c.length;e<d.length;e+=1)u(e);F()}t[8]?p?(p.p(t,r),256&r[0]&&W(p,1)):(p=Jn(t),p.c(),W(p,1),p.m(o,null)):p&&(q(),z(p,1,1,()=>{p=null}),F()),(!i||32768&r[0])&&A(e,"drawing",t[15]),(!i||32&r[0])&&A(e,"editing",t[5]),(!i||8&r[0])&&A(e,"hidden",!t[3]),(!i||65536&r[0])&&A(e,"hover",t[16])},i(t){if(!i){for(let t=0;t<c.length;t+=1)W(d[t]);W(p),i=!0}},o(t){d=d.filter(Boolean);for(let t=0;t<d.length;t+=1)z(d[t]);z(p),i=!1},d(n){n&&m(e),y(d,n),p&&p.d(),t[35](null),t[36](null),s=!1,r(l)}}}function io(t,e,o){let i,s,r,a,u,p,h,g,f,m,y,$,w=n;t.$$.on_destroy.push(()=>w());let v,b,x,{drawingEnabled:E}=e,{image:A}=e,{preferredDrawingMode:_}=e,{state:M}=e,{style:S}=e,{toolName:O=gn()[0]}=e,{user:I}=e,{visible:B=!0}=e,C=0;T(()=>(o(9,x=((t,e)=>{((t,e)=>{const{naturalWidth:n,naturalHeight:o}=t;if(n||o)e.setAttribute("viewBox",`0 0 ${n} ${o}`);else{const{width:n,height:o}=t;e.setAttribute("viewBox",`0 0 ${n} ${o}`),t.addEventListener("load",t=>{const n=t.target;e.setAttribute("viewBox",`0 0 ${n.naturalWidth} ${n.naturalHeight}`)})}})(t,e);const{subscribe:o,set:i}=function(t,e=n){let o;const i=new Set;function s(e){if(l(t,e)&&(t=e,o)){const e=!Kt.length;for(const e of i)e[1](),Kt.push(e,t);if(e){for(let t=0;t<Kt.length;t+=2)Kt[t][0](Kt[t+1]);Kt.length=0}}}function r(e){s(e(t))}return{set:s,update:r,subscribe:function(a,l=n){const c=[a,l];return i.add(c),1===i.size&&(o=e(s,r)||n),a(t),()=>{i.delete(c),0===i.size&&o&&(o(),o=null)}}}}(1);let s;return window.ResizeObserver&&(s=new ResizeObserver(()=>{const t=e.getBoundingClientRect(),{width:n,height:o}=e.viewBox.baseVal,s=Math.max(t.width/n,t.height/o);i(s)}),s.observe(e.parentElement)),{destroy:()=>{s&&s.disconnect()},subscribe:o}})(A,b)),w(),w=c(x,t=>o(18,$=t)),x));const{hover:Y,selection:V,store:D}=M;let N,R;return d(t,Y,t=>o(16,f=t)),d(t,V,t=>o(33,m=t)),d(t,D,t=>o(17,y=t)),t.$$set=t=>{"drawingEnabled"in t&&o(0,E=t.drawingEnabled),"image"in t&&o(25,A=t.image),"preferredDrawingMode"in t&&o(26,_=t.preferredDrawingMode),"state"in t&&o(27,M=t.state),"style"in t&&o(1,S=t.style),"toolName"in t&&o(2,O=t.toolName),"user"in t&&o(28,I=t.user),"visible"in t&&o(3,B=t.visible)},t.$$.update=()=>{4&t.$$.dirty[0]&&o(15,({tool:i,opts:s}=fn(O)||{tool:void 0,opts:void 0}),i,(o(32,s),o(2,O))),67108864&t.$$.dirty[0]|2&t.$$.dirty[1]&&o(14,r=(null==s?void 0:s.drawingMode)||_),16&t.$$.dirty[0]&&o(13,a=(t=>({elementToImage:(e,n)=>{const o=t.getBoundingClientRect(),i=t.createSVGPoint();i.x=e+o.x,i.y=n+o.y;const{x:s,y:r}=i.matrixTransform(t.getScreenCTM().inverse());return[s,r]}}))(b)),16&t.$$.dirty[0]&&o(12,({onPointerDown:u,onPointerUp:p}=((t,e)=>{const n=L();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:i=>{if(performance.now()-o<250){const{x:o,y:s}=Nn(i,t),r=Qt?10:2,a=e.getAt(o,s,void 0,r);n("click",a?{originalEvent:i,annotation:a}:{originalEvent:i})}}}})(b,D)),u,(o(11,p),o(4,b))),4&t.$$.dirty[1]&&(t=>{N&&D.unobserve(N);const e=t.filter(({editable:t})=>t).map(({id:t})=>t);e.length>0?(o(5,R=e.map(t=>D.getAnnotation(t)).filter(t=>t&&xt(t))),N=t=>{const{updated:e}=t.changes;o(5,R=null==e?void 0:e.map(t=>t.newValue))},D.observe(N,{annotations:e})):o(5,R=void 0)})(m.selected),32&t.$$.dirty[0]&&o(6,h=R?R.map(t=>({annotation:t,editor:Qe(t.target.selector)})).filter(t=>t.editor):void 0),64&t.$$.dirty[0]&&o(10,g=t=>h&&h.some(e=>e.annotation.id===t.id))},[E,S,O,B,b,R,h,C,v,x,g,p,u,a,r,i,f,y,$,Y,V,D,t=>{const e=Tt(),n={id:e,bodies:[],target:{annotation:e,selector:t.detail,creator:I,created:new Date}};D.addAnnotation(n),V.setSelected(n.id)},t=>e=>{var n;const{target:o}=t,i=(null==(n=o.creator)?void 0:n.id)!==I.id||!o.created||(new Date).getTime()-o.created.getTime()>6e5;D.updateTarget({...o,selector:e.detail,created:i?o.created:new Date,updated:i?new Date:void 0,updatedBy:i?I:void 0})},t=>{const{x:e,y:n}=Nn(t,b),o=D.getAt(e,n,void 0,2);o?f!==o.id&&Y.set(o.id):Y.set(void 0)},A,_,M,I,()=>o(7,C+=1),()=>O,()=>E,s,m,t=>xt(t),function(t){k[t?"unshift":"push"](()=>{v=t,o(8,v)})},function(t){k[t?"unshift":"push"](()=>{b=t,o(4,b)})}]}class so extends et{constructor(t){super(),tt(this,t,io,oo,l,{drawingEnabled:0,image:25,preferredDrawingMode:26,state:27,style:1,toolName:2,user:28,visible:3,cancelDrawing:29,getDrawingTool:30,isDrawingEnabled:31},null,[-1,-1])}get cancelDrawing(){return this.$$.ctx[29]}get getDrawingTool(){return this.$$.ctx[30]}get isDrawingEnabled(){return this.$$.ctx[31]}}function ro(t,e,n=0,o=t.length-1,i=lo){for(;o>n;){if(o-n>600){const s=o-n+1,r=e-n+1,a=Math.log(s),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(s-l)/s)*(r-s/2<0?-1:1);ro(t,e,Math.max(n,Math.floor(e-r*l/s+c)),Math.min(o,Math.floor(e+(s-r)*l/s+c)),i)}const s=t[e];let r=n,a=o;for(ao(t,n,e),i(t[o],s)>0&&ao(t,n,o);r<a;){for(ao(t,r,a),r++,a--;i(t[r],s)<0;)r++;for(;i(t[a],s)>0;)a--}0===i(t[n],s)?ao(t,n,a):(a++,ao(t,a,o)),a<=e&&(n=a+1),e<=a&&(o=a-1)}}function ao(t,e,n){const o=t[e];t[e]=t[n],t[n]=o}function lo(t,e){return t<e?-1:t>e?1:0}class co{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!xo(t,e))return n;const o=this.toBBox,i=[];for(;e;){for(let s=0;s<e.children.length;s++){const r=e.children[s],a=e.leaf?o(r):r;xo(t,a)&&(e.leaf?n.push(r):bo(t,a)?this._all(r,n):i.push(r))}e=i.pop()}return n}collides(t){let e=this.data;if(!xo(t,e))return!1;const n=[];for(;e;){for(let o=0;o<e.children.length;o++){const i=e.children[o],s=e.leaf?this.toBBox(i):i;if(xo(t,s)){if(e.leaf||bo(t,s))return!0;n.push(i)}}e=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let e=0;e<t.length;e++)this.insert(t[e]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const t=this.data;this.data=e,e=t}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Eo([]),this}remove(t,e){if(!t)return this;let n=this.data;const o=this.toBBox(t),i=[],s=[];let r,a,l;for(;n||i.length;){if(n||(n=i.pop(),a=i[i.length-1],r=s.pop(),l=!0),n.leaf){const o=uo(t,n.children,e);if(-1!==o)return n.children.splice(o,1),i.push(n),this._condense(i),this}l||n.leaf||!bo(n,o)?a?(r++,n=a.children[r],l=!1):n=null:(i.push(n),s.push(r),r=0,a=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,o){const i=n-e+1;let s,r=this._maxEntries;if(i<=r)return s=Eo(t.slice(e,n+1)),po(s,this.toBBox),s;o||(o=Math.ceil(Math.log(i)/Math.log(r)),r=Math.ceil(i/Math.pow(r,o-1))),s=Eo([]),s.leaf=!1,s.height=o;const a=Math.ceil(i/r),l=a*Math.ceil(Math.sqrt(r));Ao(t,e,n,l,this.compareMinX);for(let i=e;i<=n;i+=l){const e=Math.min(i+l-1,n);Ao(t,i,e,a,this.compareMinY);for(let n=i;n<=e;n+=a){const i=Math.min(n+a-1,e);s.children.push(this._build(t,n,i,o-1))}}return po(s,this.toBBox),s}_chooseSubtree(t,e,n,o){for(;o.push(e),!e.leaf&&o.length-1!==n;){let n,o=1/0,i=1/0;for(let s=0;s<e.children.length;s++){const r=e.children[s],a=yo(r),l=wo(t,r)-a;l<i?(i=l,o=a<o?a:o,n=r):l===i&&a<o&&(o=a,n=r)}e=n||e.children[0]}return e}_insert(t,e,n){const o=n?t:this.toBBox(t),i=[],s=this._chooseSubtree(o,this.data,e,i);for(s.children.push(t),go(s,o);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(o,i,e)}_split(t,e){const n=t[e],o=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,o);const s=this._chooseSplitIndex(n,i,o),r=Eo(n.children.splice(s,n.children.length-s));r.height=n.height,r.leaf=n.leaf,po(n,this.toBBox),po(r,this.toBBox),e?t[e-1].children.push(r):this._splitRoot(n,r)}_splitRoot(t,e){this.data=Eo([t,e]),this.data.height=t.height+1,this.data.leaf=!1,po(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let o,i=1/0,s=1/0;for(let r=e;r<=n-e;r++){const e=ho(t,0,r,this.toBBox),a=ho(t,r,n,this.toBBox),l=vo(e,a),c=yo(e)+yo(a);l<i?(i=l,o=r,s=c<s?c:s):l===i&&c<s&&(s=c,o=r)}return o||n-e}_chooseSplitAxis(t,e,n){const o=t.leaf?this.compareMinX:fo,i=t.leaf?this.compareMinY:mo;this._allDistMargin(t,e,n,o)<this._allDistMargin(t,e,n,i)&&t.children.sort(o)}_allDistMargin(t,e,n,o){t.children.sort(o);const i=this.toBBox,s=ho(t,0,e,i),r=ho(t,n-e,n,i);let a=$o(s)+$o(r);for(let o=e;o<n-e;o++){const e=t.children[o];go(s,t.leaf?i(e):e),a+=$o(s)}for(let o=n-e-1;o>=e;o--){const e=t.children[o];go(r,t.leaf?i(e):e),a+=$o(r)}return a}_adjustParentBBoxes(t,e,n){for(let o=n;o>=0;o--)go(e[o],t)}_condense(t){for(let e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children,e.splice(e.indexOf(t[n]),1)):this.clear():po(t[n],this.toBBox)}}function uo(t,e,n){if(!n)return e.indexOf(t);for(let o=0;o<e.length;o++)if(n(t,e[o]))return o;return-1}function po(t,e){ho(t,0,t.children.length,e,t)}function ho(t,e,n,o,i){i||(i=Eo(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=e;s<n;s++){const e=t.children[s];go(i,t.leaf?o(e):e)}return i}function go(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function fo(t,e){return t.minX-e.minX}function mo(t,e){return t.minY-e.minY}function yo(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function $o(t){return t.maxX-t.minX+(t.maxY-t.minY)}function wo(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function vo(t,e){const n=Math.max(t.minX,e.minX),o=Math.max(t.minY,e.minY),i=Math.min(t.maxX,e.maxX),s=Math.min(t.maxY,e.maxY);return Math.max(0,i-n)*Math.max(0,s-o)}function bo(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function xo(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function Eo(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Ao(t,e,n,o,i){const s=[e,n];for(;s.length;){if((n=s.pop())-(e=s.pop())<=o)continue;const r=e+Math.ceil((n-e)/o/2)*o;ro(t,r,e,n,i),s.push(e,r,r,n)}}const _o=t=>({...t,subscribe:e=>{const n=t=>e(t.state);return t.observe(n),e(t.all()),()=>t.unobserve(n)}}),Mo=t=>{const e=(()=>{const t=new Map,e=new Map,n=[],o=(e,o)=>{const i={origin:e,changes:{created:o.created||[],updated:o.updated||[],deleted:o.deleted||[]},state:[...t.values()]};n.forEach(t=>{((t,e)=>{var n,o;const{changes:i,origin:s}=e;if(!(t.options.origin?t.options.origin===s:"SILENT"!==s))return!1;if(t.options.ignore){const{ignore:e}=t.options,s=t=>t&&t.length>0;if(!s(i.created)&&!s(i.deleted)){const t=null==(n=i.updated)?void 0:n.some(t=>s(t.bodiesCreated)||s(t.bodiesDeleted)||s(t.bodiesUpdated)),r=null==(o=i.updated)?void 0:o.some(t=>t.targetUpdated);if("BODY_ONLY"===e&&t&&!r||"TARGET_ONLY"===e&&r&&!t)return!1}}if(t.options.annotations){const e=new Set([...(i.created||[]).map(t=>t.id),...(i.deleted||[]).map(t=>t.id),...(i.updated||[]).map(({oldValue:t})=>t.id)]);return!!(Array.isArray(t.options.annotations)?t.options.annotations:[t.options.annotations]).find(t=>e.has(t))}return!0})(t,i)&&t.onChange(i)})},i=(n,i=Gt.LOCAL)=>{if(n.id&&t.get(n.id))throw Error(`Cannot add annotation ${n.id} - exists already`);{const s=qt(n);t.set(s.id,s),s.bodies.forEach(t=>e.set(t.id,s.id)),o(i,{created:[s]})}},s=(n,o)=>{const i=qt("string"==typeof n?o:n),s="string"==typeof n?n:n.id,r=s&&t.get(s);if(r){const n=jt(r,i);return s===i.id?t.set(s,i):(t.delete(s),t.set(i.id,i)),r.bodies.forEach(t=>e.delete(t.id)),i.bodies.forEach(t=>e.set(t.id,i.id)),n}console.warn(`Cannot update annotation ${s} - does not exist`)},r=(t,e=Gt.LOCAL,n=Gt.LOCAL)=>{const i=(t=>void 0!==t.id)(e)?n:e,r=s(t,e);r&&o(i,{updated:[r]})},a=n=>{const o="string"==typeof n?n:n.id,i=t.get(o);if(i)return t.delete(o),i.bodies.forEach(t=>e.delete(t.id)),i;console.warn(`Attempt to delete missing annotation: ${o}`)},l=n=>{const o=t.get(n.annotation);if(o){const i=o.bodies.find(t=>t.id===n.id);if(i){e.delete(i.id);const s={...o,bodies:o.bodies.filter(t=>t.id!==n.id)};return t.set(o.id,s),{oldValue:o,newValue:s,bodiesDeleted:[i]}}console.warn(`Attempt to delete missing body ${n.id} from annotation ${n.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${n.annotation}`)},c=e=>{const n=t.get(e);return n?{...n}:void 0},d=(n,o)=>{if(n.annotation!==o.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const i=t.get(n.annotation);if(i){const s=i.bodies.find(t=>t.id===n.id),r={...i,bodies:i.bodies.map(t=>t.id===s.id?o:t)};return t.set(i.id,r),s.id!==o.id&&(e.delete(s.id),e.set(o.id,r.id)),{oldValue:i,newValue:r,bodiesUpdated:[{oldBody:s,newBody:o}]}}console.warn(`Attempt to add body to missing annotation ${n.annotation}`)},u=e=>{const n=t.get(e.annotation);if(n){const o={...n,target:{...n.target,...e}};return t.set(n.id,o),{oldValue:n,newValue:o,targetUpdated:{oldTarget:n.target,newTarget:e}}}console.warn(`Attempt to update target on missing annotation: ${e.annotation}`)};return{addAnnotation:i,addBody:(n,i=Gt.LOCAL)=>{const s=t.get(n.annotation);if(s){const r={...s,bodies:[...s.bodies,n]};t.set(s.id,r),e.set(n.id,r.id),o(i,{updated:[{oldValue:s,newValue:r,bodiesCreated:[n]}]})}else console.warn(`Attempt to add body to missing annotation: ${n.annotation}`)},all:()=>[...t.values()],bulkAddAnnotations:(n,i=!0,s=Gt.LOCAL)=>{const r=n.map(qt);if(i){const n=[...t.values()];t.clear(),e.clear(),r.forEach(n=>{t.set(n.id,n),n.bodies.forEach(t=>e.set(t.id,n.id))}),o(s,{created:r,deleted:n})}else{const i=n.reduce((e,n)=>{const o=n.id&&t.get(n.id);return o?[...e,o]:e},[]);if(i.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${i.map(t=>t.id).join(", ")}`);r.forEach(n=>{t.set(n.id,n),n.bodies.forEach(t=>e.set(t.id,n.id))}),o(s,{created:r})}},bulkDeleteAnnotations:(t,e=Gt.LOCAL)=>{const n=t.reduce((t,e)=>{const n=a(e);return n?[...t,n]:t},[]);n.length>0&&o(e,{deleted:n})},bulkDeleteBodies:(t,e=Gt.LOCAL)=>{const n=t.map(t=>l(t)).filter(Boolean);n.length>0&&o(e,{updated:n})},bulkUpdateAnnotations:(t,e=Gt.LOCAL)=>{const n=t.reduce((t,e)=>{const n=s(e);return n?[...t,n]:t},[]);n.length>0&&o(e,{updated:n})},bulkUpdateBodies:(t,e=Gt.LOCAL)=>{const n=t.map(t=>d({id:t.id,annotation:t.annotation},t)).filter(Boolean);o(e,{updated:n})},bulkUpdateTargets:(t,e=Gt.LOCAL)=>{const n=t.map(t=>u(t)).filter(Boolean);n.length>0&&o(e,{updated:n})},bulkUpsertAnnotations:(n,i=Gt.LOCAL)=>{const r=n.map(qt),{toAdd:a,toUpdate:l}=r.reduce((e,n)=>t.get(n.id)?{...e,toUpdate:[...e.toUpdate,n]}:{...e,toAdd:[...e.toAdd,n]},{toAdd:[],toUpdate:[]}),c=l.map(t=>s(t,i)).filter(Boolean);a.forEach(n=>{t.set(n.id,n),n.bodies.forEach(t=>e.set(t.id,n.id))}),o(i,{created:a,updated:c})},clear:(n=Gt.LOCAL)=>{const i=[...t.values()];t.clear(),e.clear(),o(n,{deleted:i})},deleteAnnotation:(t,e=Gt.LOCAL)=>{const n=a(t);n&&o(e,{deleted:[n]})},deleteBody:(t,e=Gt.LOCAL)=>{const n=l(t);n&&o(e,{updated:[n]})},getAnnotation:c,getBody:t=>{const n=e.get(t);if(n){const e=c(n).bodies.find(e=>e.id===t);if(e)return e;console.error(`Store integrity error: body ${t} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${t}`)},observe:(t,e={})=>{n.push({onChange:t,options:e})},unobserve:t=>{const e=n.findIndex(e=>e.onChange==t);e>-1&&n.splice(e,1)},updateAnnotation:r,updateBody:(t,e,n=Gt.LOCAL)=>{const i=d(t,e);i&&o(n,{updated:[i]})},updateTarget:(t,e=Gt.LOCAL)=>{const n=u(t);n&&o(e,{updated:[n]})},upsertAnnotation:(e,n=Gt.LOCAL)=>{t.get(e.id)?r(e,n):i(e,n)}}})(),n=(()=>{const t=new co,e=new Map,n=()=>{t.clear(),e.clear()},o=n=>{if(!Et(n))return;const{minX:o,minY:i,maxX:s,maxY:r}=n.selector.geometry.bounds,a={minX:o,minY:i,maxX:s,maxY:r,target:n};t.insert(a),e.set(n.annotation,a)},i=n=>{if(!Et(n))return;const o=e.get(n.annotation);o&&t.remove(o),e.delete(n.annotation)};return{all:()=>[...e.values()],clear:n,getAt:(e,n,o=0)=>{const i=t.search({minX:e-o,minY:n-o,maxX:e+o,maxY:n+o}).map(t=>t.target).filter(t=>t.selector.type===ot.RECTANGLE||((t,e,n,o)=>it[t.type].intersects(t,e,n,o))(t.selector,e,n,o));return i.length>0?(i.sort((t,e)=>rt(t.selector)-rt(e.selector)),i):[]},getIntersecting:(e,n,o,i)=>t.search({minX:e,minY:n,maxX:e+o,maxY:n+i}).map(t=>t.target),insert:o,remove:i,set:(o,i=!0)=>{i&&n();const s=o.reduce((t,e)=>{if(Et(e)){const{minX:n,minY:o,maxX:i,maxY:s}=e.selector.geometry.bounds;return[...t,{minX:n,minY:o,maxX:i,maxY:s,target:e}]}return t},[]);s.forEach(t=>e.set(t.target.annotation,t)),t.load(s)},size:()=>t.all().length,update:(t,e)=>{i(t),o(e)}}})(),o=((t,e,n)=>{const o=Bt(Yt);let i=e;const s=()=>{var t;return 0===(null==(t=o.get().selected)?void 0:t.length)},r=(e,n)=>{const i=Array.isArray(e)?e:[e],s=i.map(e=>t.getAnnotation(e)).filter(t=>!!t);o.set({selected:s.map(t=>{const e=void 0===n?"EDIT"===a(t):n;return{id:t.id,editable:e}})}),s.length!==i.length&&console.warn("Invalid selection",e)},a=t=>Vt(t,i,n);return t.observe(({changes:t})=>(t=>{if(s())return!1;const{selected:e}=o.get();e.some(({id:e})=>t.includes(e))&&o.set({selected:e.filter(({id:e})=>!t.includes(e))})})((t.deleted||[]).map(t=>t.id))),{get event(){const t=o.get();return t?t.event:null},get selected(){const t=o.get();return t?[...t.selected]:null},get userSelectAction(){return i},clear:()=>{Ot(o.get(),Yt)||o.set(Yt)},evalSelectAction:a,isEmpty:s,isSelected:t=>{if(s())return!1;const e="string"==typeof t?t:t.id;return o.get().selected.some(t=>t.id===e)},setSelected:r,setUserSelectAction:t=>{i=t,r(o.get().selected.map(({id:t})=>t))},subscribe:o.subscribe.bind(o),userSelect:(e,n)=>{let i;if(Array.isArray(e)){if(i=e.map(e=>t.getAnnotation(e)).filter(Boolean),i.length<e.length)return void console.warn("Invalid selection: "+e.filter(t=>!i.some(e=>e.id===t)))}else{const n=t.getAnnotation(e);if(!n)return void console.warn("Invalid selection: "+e);i=[n]}const s=i.reduce((t,e)=>{const n=a(e);return"EDIT"===n?[...t,{id:e.id,editable:!0}]:"SELECT"===n?[...t,{id:e.id}]:t},[]);o.set({selected:s,event:n})}}})(e,t.userSelectAction,t.adapter),i=(t=>{const e=Bt(null);return t.observe(({changes:t})=>{const n=e.get();if(n){(t.deleted||[]).some(t=>t.id===n)&&e.set(null);const o=(t.updated||[]).find(({oldValue:t})=>t.id===n);o&&e.set(o.newValue.id)}}),{get current(){return e.get()},subscribe:e.subscribe.bind(e),set:e.set.bind(e)}})(e),s=(()=>{const t=Bt([]);return{subscribe:t.subscribe.bind(t),set:t.set.bind(t)}})();return e.observe(({changes:t})=>{n.set((t.created||[]).map(t=>t.target),!1),(t.deleted||[]).forEach(t=>n.remove(t.target)),(t.updated||[]).forEach(({oldValue:t,newValue:e})=>n.update(t.target,e.target))}),{store:{...e,getAt:(t,o,i,s)=>{const r=n.getAt(t,o,s);if(i)return r.map(t=>e.getAnnotation(t.annotation)).filter(Boolean).filter(i)[0];{const t=r[0];return t?e.getAnnotation(t.annotation):void 0}},getIntersecting:(t,o,i,s)=>n.getIntersecting(t,o,i,s).map(t=>e.getAnnotation(t.annotation)).filter(Boolean)},selection:o,hover:i,viewport:s}},So=(t,e,n)=>e.setAttribute("data-theme","auto"===n?(t=>{const e=(t=>{let e,n;if("CANVAS"===t.nodeName)e=t,n=e.getContext("2d",{willReadFrequently:!0});else{const o=t;e=document.createElement("canvas"),e.width=o.width,e.height=o.height,n=e.getContext("2d",{willReadFrequently:!0}),n.drawImage(o,0,0,o.width,o.height)}let o=0;for(let t=1;t<10;t++)for(let i=1;i<10;i++){const s=Math.round(i*e.width/10),r=Math.round(t*e.height/10),a=n.getImageData(s,r,1,1).data;o+=(.299*a[0]+.587*a[1]+.114*a[2])/255}return o/81})(t),n=e>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${e.toFixed(1)}. Setting ${n} theme.`),n})(t):n),To=!(typeof navigator>"u")&&-1!==navigator.userAgent.indexOf("Mac OS X"),Lo=(t,e={})=>{if(!t)throw"Missing argument: image";const n="string"==typeof t?document.getElementById(t):t,o=((t,e)=>({...t,drawingEnabled:void 0===t.drawingEnabled?e.drawingEnabled:t.drawingEnabled,drawingMode:t.drawingMode||e.drawingMode,userSelectAction:t.userSelectAction||e.userSelectAction,theme:t.theme||e.theme}))(e,{drawingEnabled:!0,drawingMode:"drag",userSelectAction:Ct.EDIT,theme:"light"}),i=(t=>{const e=Mo(t);return{...e,store:_o(e.store)}})(o),{selection:s,store:r}=i,a=((t,e)=>{const n=Ft(),o=(null==e?void 0:e.changes)||[];let i=e?e.pointer:-1,s=!1,r=0;const a=t=>{if(!s){const{changes:e}=t,n=performance.now();if(n-r>250)o.splice(i+1),o.push(e),i=o.length-1;else{const t=o.length-1;o[t]=((t,e)=>{const n=new Set((t.created||[]).map(t=>t.id)),o=new Set((t.updated||[]).map(({newValue:t})=>t.id)),i=new Set((e.created||[]).map(t=>t.id)),s=new Set((e.deleted||[]).map(t=>t.id)),r=new Set((e.updated||[]).map(({oldValue:t})=>t.id)),a=new Set((e.updated||[]).filter(({oldValue:t})=>n.has(t.id)||o.has(t.id)).map(({oldValue:t})=>t.id));return{created:[...(t.created||[]).filter(t=>!s.has(t.id)).map(t=>r.has(t.id)?e.updated.find(({oldValue:e})=>e.id===t.id).newValue:t),...e.created||[]],deleted:[...(t.deleted||[]).filter(t=>!i.has(t.id)),...(e.deleted||[]).filter(t=>!n.has(t.id))],updated:[...(t.updated||[]).filter(({newValue:t})=>!s.has(t.id)).map(t=>{const{oldValue:n,newValue:o}=t;if(r.has(o.id)){const t=e.updated.find(t=>t.oldValue.id===o.id).newValue;return jt(n,t)}return t}),...(e.updated||[]).filter(({oldValue:t})=>!a.has(t.id))]}})(o[t],e)}r=n}s=!1};return t.observe(a,{origin:Gt.LOCAL}),{canRedo:()=>o.length-1>i,canUndo:()=>i>-1,destroy:()=>t.unobserve(a),getHistory:()=>({changes:[...o],pointer:i}),on:(t,e)=>n.on(t,e),redo:()=>{if(o.length-1>i){s=!0;const{created:e,updated:r,deleted:a}=o[i+1];(e=>{e&&e.length>0&&t.bulkAddAnnotations(e,!1)})(e),(e=>{e&&e.length>0&&t.bulkUpdateAnnotations(e.map(({newValue:t})=>t))})(r),(e=>{e&&e.length>0&&t.bulkDeleteAnnotations(e)})(a),n.emit("redo",o[i+1]),i+=1}},undo:()=>{if(i>-1){s=!0;const{created:e,updated:r,deleted:a}=o[i];(e=>{e&&e.length>0&&t.bulkDeleteAnnotations(e)})(e),(e=>{e&&e.length>0&&t.bulkUpdateAnnotations(e.map(({oldValue:t})=>t))})(r),(e=>{e&&e.length>0&&t.bulkAddAnnotations(e,!1)})(a),n.emit("undo",o[i]),i-=1}}}})(r,o.initialHistory),l=((t,e,n,o)=>{const{hover:i,selection:s,store:r,viewport:a}=t,l=new Map;let c,d,u=[];const p=(t,e,o)=>{l.has(t)&&setTimeout(()=>{l.get(t).forEach(t=>{n?t(Array.isArray(e)?e.map(t=>n.serialize(t)):n.serialize(e),o?o instanceof PointerEvent?o:n.serialize(o):void 0):t(e,o)})},1)},h=()=>{const{selected:t}=s,e=(t||[]).map(({id:t})=>r.getAnnotation(t));e.forEach(t=>{const e=u.find(e=>e.id===t.id);(!e||!Ot(e,t))&&p("updateAnnotation",t,e)}),u=u.map(t=>e.find(({id:e})=>e===t.id)||t)};s.subscribe(({selected:t})=>{if(0!==u.length||0!==t.length){if(0===u.length&&t.length>0)u=t.map(({id:t})=>r.getAnnotation(t));else if(u.length>0&&0===t.length)u.forEach(t=>{const e=r.getAnnotation(t.id);e&&!Ot(e,t)&&p("updateAnnotation",e,t)}),u=[];else{const e=new Set(u.map(t=>t.id)),n=new Set(t.map(({id:t})=>t));u.filter(t=>!n.has(t.id)).forEach(t=>{const e=r.getAnnotation(t.id);e&&!Ot(e,t)&&p("updateAnnotation",e,t)}),u=[...u.filter(t=>n.has(t.id)),...t.filter(({id:t})=>!e.has(t)).map(({id:t})=>r.getAnnotation(t))]}p("selectionChanged",u)}}),i.subscribe(t=>{!c&&t?p("mouseEnterAnnotation",r.getAnnotation(t)):c&&!t?p("mouseLeaveAnnotation",r.getAnnotation(c)):c&&t&&(p("mouseLeaveAnnotation",r.getAnnotation(c)),p("mouseEnterAnnotation",r.getAnnotation(t))),c=t}),null==a||a.subscribe(t=>p("viewportIntersect",t.map(t=>r.getAnnotation(t)))),r.observe(t=>{o&&(d&&clearTimeout(d),d=setTimeout(h,1e3));const{created:e,deleted:n}=t.changes;(e||[]).forEach(t=>p("createAnnotation",t)),(n||[]).forEach(t=>p("deleteAnnotation",t)),(t.changes.updated||[]).filter(t=>[...t.bodiesCreated||[],...t.bodiesDeleted||[],...t.bodiesUpdated||[]].length>0).forEach(({oldValue:t,newValue:e})=>{const n=u.find(e=>e.id===t.id)||t;u=u.map(n=>n.id===t.id?e:n),p("updateAnnotation",e,n)})},{origin:Gt.LOCAL}),r.observe(t=>{if(u){const e=new Set(u.map(t=>t.id)),n=(t.changes.updated||[]).filter(({newValue:t})=>e.has(t.id)).map(({newValue:t})=>t);n.length>0&&(u=u.map(t=>n.find(e=>e.id===t.id)||t))}},{origin:Gt.REMOTE});const g=t=>e=>{const{updated:n}=e;t?(n||[]).forEach(t=>p("updateAnnotation",t.oldValue,t.newValue)):(n||[]).forEach(t=>p("updateAnnotation",t.newValue,t.oldValue))};return e.on("undo",g(!0)),e.on("redo",g(!1)),{on:(t,e)=>{l.has(t)?l.get(t).push(e):l.set(t,[e])},off:(t,e)=>{const n=l.get(t);if(n){const t=n.indexOf(e);-1!==t&&n.splice(t,1)}},emit:p}})(i,a,o.adapter,o.autoSave),c=document.createElement("DIV");c.style.position="relative",c.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(c,n),c.appendChild(n);const d=(t=>{const e=document,n=e=>{const n=e;"z"===n.key&&n.ctrlKey?t.undo():"y"===n.key&&n.ctrlKey&&t.redo()},o=e=>{const n=e;"z"===n.key&&n.metaKey&&(n.shiftKey?t.redo():t.undo())};return To?e.addEventListener("keydown",o):e.addEventListener("keydown",n),{destroy:()=>{To?e.removeEventListener("keydown",o):e.removeEventListener("keydown",n)}}})(a);let u={isGuest:!0,id:zt("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()};So(n,c,o.theme);const p=new so({target:c,props:{drawingEnabled:!!o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:u}});p.$on("click",t=>{const{originalEvent:e,annotation:n}=t.detail;n?s.userSelect(n.id,e):s.isEmpty()||s.clear()});const h=((t,e,n)=>{const{store:o,selection:i}=t,s=(t,e=!0)=>{if(n){const i=n.parseAll||(t=>e=>e.reduce((e,n)=>{const{parsed:o,error:i}=t.parse(n);return i?{parsed:e.parsed,failed:[...e.failed,n]}:o?{parsed:[...e.parsed,o],failed:e.failed}:{...e}},{parsed:[],failed:[]}))(n),{parsed:s,failed:r}=i(t);r.length>0&&console.warn(`Discarded ${r.length} invalid annotations`,r),o.bulkAddAnnotations(s,e,Gt.REMOTE)}else o.bulkAddAnnotations(t.map(Pt),e,Gt.REMOTE)};return{addAnnotation:t=>{if(n){const{parsed:e,error:i}=n.parse(t);e?o.addAnnotation(e,Gt.REMOTE):console.error(i)}else o.addAnnotation(Pt(t),Gt.REMOTE)},cancelSelected:()=>i.clear(),canRedo:e.canRedo,canUndo:e.canUndo,clearAnnotations:()=>o.clear(),getAnnotationById:t=>{const e=o.getAnnotation(t);return n&&e?n.serialize(e):e},getAnnotations:()=>n?o.all().map(n.serialize):o.all(),getHistory:e.getHistory,getSelected:()=>{var t;const e=((null==(t=i.selected)?void 0:t.map(t=>t.id))||[]).map(t=>o.getAnnotation(t)).filter(Boolean);return n?e.map(n.serialize):e},loadAnnotations:(t,e=!0)=>fetch(t).then(t=>t.json()).then(t=>(s(t,e),t)),redo:e.redo,removeAnnotation:t=>{if("string"==typeof t){const e=o.getAnnotation(t);if(o.deleteAnnotation(t),e)return n?n.serialize(e):e}else{const e=n?n.parse(t).parsed:t;if(e)return o.deleteAnnotation(e),t}},setAnnotations:s,setSelected:(t,e)=>{t?i.setSelected(t,e):i.clear()},setUserSelectAction:t=>{i.setUserSelectAction(t)},undo:e.undo,updateAnnotation:t=>{if(n){const e=n.parse(t).parsed,i=n.serialize(o.getAnnotation(e.id));return o.updateAnnotation(e),i}{const e=o.getAnnotation(t.id);return o.updateAnnotation(Pt(t)),e}}}})(i,a,o.adapter);return{...h,cancelDrawing:()=>p.cancelDrawing(),destroy:()=>{p.$destroy(),c.parentNode.insertBefore(n,c),c.parentNode.removeChild(c),d.destroy(),a.destroy()},getDrawingTool:()=>p.getDrawingTool(),getUser:()=>u,isDrawingEnabled:()=>p.isDrawingEnabled(),listDrawingTools:gn,on:l.on,off:l.off,registerDrawingTool:(t,e,n)=>((t,e,n={})=>hn.set(t,{tool:e,opts:n}))(t,e,n),registerShapeEditor:(t,e)=>((t,e)=>Ze.set(t,e))(t,e),setDrawingEnabled:t=>p.$set({drawingEnabled:t}),setDrawingTool:t=>{if(!fn(t))throw`No drawing tool named ${t}`;p.$set({toolName:t})},setFilter:t=>{console.warn("Filter not implemented yet")},setStyle:t=>p.$set({style:t}),setTheme:t=>So(n,c,t),setUser:t=>{u=t,p.$set({user:t})},setVisible:t=>p.$set({visible:t}),element:c,state:i}},Oo=document.createElement("template");function Io(t,e){window.K2&&"function"==typeof window.K2.RaisePropertyChanged?window.K2.RaisePropertyChanged(t,e):console.log("[image-annotation] Property changed:",e,"=",t[e])}Oo.innerHTML='\n  <div class="image-wrapper">\n    <img class="annotatable-image" />\n  </div>\n',window.customElements.get("image-annotation")||window.customElements.define("image-annotation",class extends HTMLElement{constructor(){super(),this._src="",this._value=[],this._hasRendered=!1,this._anno=null,this._onAnnoChange=null,this._selectedAnnotation=null,this._height="",this._width="",this._isVisible=!0,this._isEnabled=!0,this._isReadOnly=!1,this.editor=null,this.editorTextarea=null,this.deleteBtn=null}static get observedAttributes(){return["src"]}attributeChangedCallback(t,e,n){"src"===t&&e!==n&&(this._src=n||"",this.img&&(this.img.src=this._src))}async connectedCallback(){if(this._hasRendered)return;this.appendChild(Oo.content.cloneNode(!0)),this.img=this.querySelector(".annotatable-image"),this.imageWrapper=this.querySelector(".image-wrapper"),this.imageWrapper&&(this.imageWrapper.style.position="relative"),this._src=this._src||this.getAttribute("src")||this._src,this._src&&(this.img.src=this._src),this._height&&(this.Height=this._height),this._width&&(this.Width=this._width),this.IsVisible=this._isVisible,this.IsEnabled=this._isEnabled,this.IsReadOnly=this._isReadOnly,this._initTextEditorUI(),this._initDeleteButtonUI();const t=`anno-img-${Math.random().toString(36).slice(2)}`;this.img.id=t,this._anno=Lo(t),this._onAnnoChange=()=>{this._syncFromAnno()},Array.isArray(this._value)&&this._value.length>0&&this._anno.setAnnotations&&this._anno.setAnnotations(this._value,!0),this._anno.on&&(this._anno.on("createAnnotation",this._onAnnoChange),this._anno.on("updateAnnotation",this._onAnnoChange),this._anno.on("deleteAnnotation",this._onAnnoChange),this._anno.on("selectionChanged",t=>{const e=t&&t.length?t[0]:null;this._selectedAnnotation=e,e?this._showTextEditor(e):this._hideTextEditor(),this._updateDeleteButtonVisibility()})),this._hasRendered=!0,this.dispatchEvent(new Event("Rendered"))}disconnectedCallback(){this._anno&&(this._onAnnoChange&&this._anno.off&&(this._anno.off("createAnnotation",this._onAnnoChange),this._anno.off("updateAnnotation",this._onAnnoChange),this._anno.off("deleteAnnotation",this._onAnnoChange)),this._anno.destroy&&this._anno.destroy(),this._anno=null)}_syncFromAnno(){if(!this._anno||!this._anno.getAnnotations)return;this._value=this._anno.getAnnotations()||[];const t=this.Value;console.log("[image-annotation] annotations updated:",t),Io(this,"Value"),this.dispatchEvent(new Event("change",{bubbles:!0})),this.dispatchEvent(new CustomEvent("Changed",{detail:{value:t}}))}_initTextEditorUI(){if(!this.imageWrapper||this.editor)return;const t=document.createElement("div");t.className="anno-text-editor",t.innerHTML='\n        <textarea class="anno-textarea" rows="2" placeholder="Add a comment"></textarea>\n      ',t.style.display="none",this.imageWrapper.appendChild(t),this.editor=t,this.editorTextarea=t.querySelector(".anno-textarea"),this.editorTextarea.addEventListener("input",()=>{if(!this._selectedAnnotation)return;const t=this.editorTextarea.value;let e=this._selectedAnnotation.bodies||[],n=e.find(t=>"commenting"===t.purpose||!t.purpose);t&&t.trim()?n?n.value=t:(n={id:(this._selectedAnnotation.id||"anno")+"-body-"+Date.now(),purpose:"commenting",value:t},e=e.concat([n])):n&&(e=e.filter(t=>t!==n)),this._selectedAnnotation.bodies=e,this._anno&&this._anno.updateAnnotation&&this._anno.updateAnnotation(this._selectedAnnotation),this._syncFromAnno()})}_showTextEditor(t){if(!this.editor||!this.editorTextarea)return;const e=(t.bodies||[]).find(t=>"commenting"===t.purpose||!t.purpose);this.editorTextarea.value=e&&e.value?e.value:"",this._positionTextEditor(t),this.editor.style.display="block"}_hideTextEditor(){this.editor&&(this.editor.style.display="none")}_positionTextEditor(t){if(!this.editor||!this.img)return;const e=t&&t.target&&t.target.selector,n=e&&e.geometry,o=n&&n.bounds;if(!o||!this.img.naturalWidth||!this.img.naturalHeight)return this.editor.style.left="8px",this.editor.style.bottom="8px",void(this.editor.style.top="auto");const i=this.img.clientWidth/this.img.naturalWidth,s=this.img.clientHeight/this.img.naturalHeight,r=o.minX*i,a=o.maxY*s+4;this.editor.style.left=`${r}px`,this.editor.style.top=`${a}px`,this.editor.style.bottom="auto"}_initDeleteButtonUI(){if(!this.imageWrapper||this.deleteBtn)return;const t=document.createElement("button");t.type="button",t.className="anno-delete-button",t.title="Delete annotation",t.innerHTML="",t.style.display="none",t.addEventListener("click",()=>{if(this._selectedAnnotation&&this._anno){try{this._anno.removeAnnotation(this._selectedAnnotation)}catch(t){console.warn("[image-annotation] Failed to remove annotation",t)}this._selectedAnnotation=null,this._hideTextEditor(),this._updateDeleteButtonVisibility(),this._syncFromAnno()}}),this.imageWrapper.appendChild(t),this.deleteBtn=t,this._updateDeleteButtonVisibility()}_updateDeleteButtonVisibility(){if(!this.deleteBtn)return;const t=!!this._selectedAnnotation&&this._isEnabled&&!this._isReadOnly;this.deleteBtn.style.display=t?"block":"none",this.deleteBtn.disabled=!t}get Value(){try{return JSON.stringify(this._value||[])}catch(t){return"[]"}}set Value(t){let e;if("string"==typeof t)if(t.trim())try{e=JSON.parse(t)}catch(t){return void console.warn("image-annotation: Value must be JSON string or array of annotations.",t)}else e=[];else{if(!Array.isArray(t))return void console.warn("image-annotation: Value must be JSON string or array of annotations.");e=t}this._value=e,this._anno&&this._anno.setAnnotations&&this._anno.setAnnotations(this._value,!0),Io(this,"Value")}get imageSourceUrl(){return this._src}set imageSourceUrl(t){this._src=t||"",this.img?this.img.src=this._src:this.setAttribute("src",this._src)}get ImageSourceUrl(){return this.imageSourceUrl}set ImageSourceUrl(t){this.imageSourceUrl=t}get Source(){return this._src}set Source(t){this.imageSourceUrl=t}get Height(){return this._height}set Height(t){this._height=t;const e=null==t||""===t?"":isNaN(t)?String(t):`${t}px`;this.style.height=e}get Width(){return this._width}set Width(t){this._width=t;const e=null==t||""===t?"":isNaN(t)?String(t):`${t}px`;this.style.width=e}get IsVisible(){return this._isVisible}set IsVisible(t){this._isVisible=!0===t||"true"===t,this.style.display=this._isVisible?"":"none"}get IsEnabled(){return this._isEnabled}set IsEnabled(t){this._isEnabled=!0===t||"true"===t,this.imageWrapper&&(this.imageWrapper.style.pointerEvents=this._isEnabled?"":"none",this.imageWrapper.classList.toggle("is-disabled",!this._isEnabled)),this._updateDeleteButtonVisibility()}get IsReadOnly(){return this._isReadOnly}set IsReadOnly(t){this._isReadOnly=!0===t||"true"===t,this.imageWrapper&&(this.imageWrapper.style.pointerEvents=this._isReadOnly?"none":"",this.imageWrapper.classList.toggle("is-readonly",this._isReadOnly)),this._updateDeleteButtonVisibility()}})})();